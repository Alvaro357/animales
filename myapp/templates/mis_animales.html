{% load static %}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Animales - Adopta</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style type="text/tailwindcss">
        html {
            font-size: 16px;
        }
        
        body {
            font-family: 'Pacifico', cursive;
            background: #0a0a0a;
            color: #ffe4cc;
            position: relative;
            overflow-x: hidden;
            min-height: 100vh;
        }
        
        /* Fondo de estrellas */
        #starfield {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
        }
        
        .star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: #ffffff;
            border-radius: 50%;
            opacity: 0;
            animation: twinkle 3s infinite;
        }
        
        .star.large {
            width: 3px;
            height: 3px;
            animation: twinkle 4s infinite;
        }
        
        .star.bright {
            background: #ffd89b;
            box-shadow: 0 0 4px #ffd89b;
        }
        
        @keyframes twinkle {
            0%, 100% { opacity: 0; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.2); }
        }
        
        .shooting-star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: linear-gradient(45deg, #ffd89b, transparent);
            border-radius: 50%;
            opacity: 0;
            animation: shoot 2s linear infinite;
        }
        
        @keyframes shoot {
            0% {
                opacity: 1;
                transform: translateX(-100px) translateY(100px);
            }
            100% {
                opacity: 0;
                transform: translateX(100px) translateY(-100px);
            }
        }
        
        .content-wrapper {
            position: relative;
            z-index: 10;
        }
        
        /* Navbar glassmorphism */
        .navbar-glass {
            backdrop-filter: blur(20px);
            background: rgba(10, 10, 10, 0.8);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Botones modernos */
        .btn-primary {
            background: linear-gradient(135deg, #ffb4a2, #ff9a7f);
            border: 1px solid rgba(255, 180, 162, 0.4);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            color: #5c4a42;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 40px rgba(255, 180, 162, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 201, 217, 0.15);
            border: 1px solid rgba(255, 201, 217, 0.3);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            color: #ffc9d9;
        }

        .btn-secondary:hover {
            background: rgba(255, 201, 217, 0.25);
            border-color: rgba(255, 201, 217, 0.5);
            transform: translateY(-1px);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ffb4a2, #ff9a7f);
            border: 1px solid rgba(255, 180, 162, 0.4);
            transition: all 0.3s ease;
            color: #5c4a42;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 40px rgba(255, 180, 162, 0.4);
        }
        
        /* Cards modernas */
        .animal-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }
        
        .animal-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 180, 162, 0.1), rgba(255, 201, 217, 0.1));
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 0;
        }

        .animal-card:hover::before {
            opacity: 1;
        }

        .animal-card:hover {
            transform: translateY(-8px);
            border-color: rgba(255, 180, 162, 0.4);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5),
                        0 0 0 1px rgba(255, 180, 162, 0.2);
        }
        
        .card-content {
            position: relative;
            z-index: 1;
        }
        
        /* Filtros */
        .filter-container {
            background: rgba(10, 10, 10, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .filter-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #ffd4b8;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            min-height: 44px;
            font-size: 16px;
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #ffb4a2, #ff9a7f);
            border-color: #ffb4a2;
            color: #5c4a42;
            box-shadow: 0 0 20px rgba(255, 180, 162, 0.5);
        }

        .filter-btn:hover:not(.active) {
            background: rgba(255, 180, 162, 0.1);
            color: #ffe4cc;
        }
        
        /* Buscador */
        .search-input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            color: #ffffff;
        }
        
        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        .search-input:focus {
            outline: none;
            border-color: #ffb4a2;
            box-shadow: 0 0 0 3px rgba(255, 180, 162, 0.2);
        }

        /* Título principal */
        .main-title {
            font-size: 3rem;
            font-weight: 700;
            line-height: 1.1;
            letter-spacing: -0.025em;
            background: linear-gradient(135deg, #ffe4cc, #ffb4a2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 2rem;
        }
        
        /* Modal moderno */
        .modal-backdrop {
            backdrop-filter: blur(10px);
            background: rgba(0, 0, 0, 0.8);
        }
        
        .modal-content {
            background: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Formularios */
        .form-input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #ffb4a2;
            box-shadow: 0 0 0 3px rgba(255, 180, 162, 0.2);
        }

        .form-label {
            color: #ffe4cc;
        }
        
        /* Estilos para select en modo oscuro */
        select.form-input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #ffffff;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }

        select.form-input option {
            background-color: #1f2937;
            color: #ffffff;
            padding: 8px 12px;
        }

        select.form-input option:checked,
        select.form-input option:hover {
            background-color: #ffb4a2;
            color: #5c4a42;
        }

        select.form-input:focus {
            outline: none;
            border-color: #ffb4a2;
            box-shadow: 0 0 0 3px rgba(255, 180, 162, 0.2);
        }
        
        /* Lazy loading */
        .lazy-image {
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .lazy-image.loaded {
            opacity: 1;
        }
        
        .lazy-placeholder {
            background: linear-gradient(90deg, 
                rgba(255, 255, 255, 0.05) 25%, 
                rgba(255, 255, 255, 0.1) 50%, 
                rgba(255, 255, 255, 0.05) 75%
            );
            background-size: 200% 100%;
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .fade-in {
            animation: fadeInUp 0.6s ease-out;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Estados */
        .badge-disponible {
            background: rgba(255, 216, 155, 0.15);
            border: 1px solid rgba(255, 216, 155, 0.3);
            color: #ffd89b;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-adoptado {
            background: rgba(255, 201, 217, 0.15);
            border: 1px solid rgba(255, 201, 217, 0.3);
            color: #ffc9d9;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .action-buttons {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            gap: 0.5rem;
            z-index: 10;
        }
        
        .action-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: none;
            cursor: pointer;
        }
        
        .edit-btn {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #60a5fa;
        }
        
        .edit-btn:hover {
            background: rgba(59, 130, 246, 0.3);
            transform: scale(1.1);
        }
        
        .delete-btn {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #f87171;
        }
        
        .delete-btn:hover {
            background: rgba(239, 68, 68, 0.3);
            transform: scale(1.1);
        }
        
        /* Spinners para crear animal */
        .create-spinner {
            border: 3px solid rgba(255, 180, 162, 0.3);
            border-left: 3px solid #ffb4a2;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        .create-spinner-small {
            border: 2px solid rgba(255, 180, 162, 0.3);
            border-left: 2px solid #ffb4a2;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-dots::after {
            content: '';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }
        
        /* Indicadores de archivo */
        .file-indicator {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.2);
            color: #22c55e;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
        }
        
        /* Estilos específicos para textarea */
        textarea.form-input {
            resize: vertical;
            min-height: 120px;
        }
    </style>
</head>
<body class="pt-20">

<!-- Fondo de estrellas -->
<div id="starfield"></div>

<!-- Wrapper de contenido -->
<div class="content-wrapper">

    <!-- Modal de Crear Animal -->
    <div id="crearAnimalModal" class="fixed inset-0 flex items-center justify-center z-50 modal-backdrop hidden">
        <div id="crearAnimalContent" class="modal-content p-8 rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto transform scale-95 opacity-0 transition-all duration-500">
            <button onclick="cerrarCrearAnimal()" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl z-10">&times;</button>
            
            <div id="crearAnimalForm">
                <h2 class="text-3xl font-semibold mb-8 text-center text-white">Registrar Nuevo Animal</h2>
                
                <!-- Overlay de loading -->
                <div id="crearAnimalLoadingOverlay" class="absolute inset-0 flex items-center justify-center hidden bg-black/80 backdrop-blur-sm rounded-2xl">
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg flex flex-col items-center border border-gray-600">
                        <div class="create-spinner mb-3"></div>
                        <p class="text-white font-medium">Creando animal...</p>
                        <p class="text-sm text-gray-400 mt-1">Por favor, no cierres esta ventana</p>
                    </div>
                </div>

                <form method="post" action="/crear_animal/" enctype="multipart/form-data" id="crearAnimalFormElement">
                    {% csrf_token %}
                    
                    <!-- Información básica -->
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold text-white mb-4 border-b border-gray-600 pb-2">Información Básica</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="animal_nombre" class="block text-sm font-medium form-label mb-2">
                                    Nombre <span class="text-red-400">*</span>
                                </label>
                                <input type="text" id="animal_nombre" name="nombre" 
                                       class="form-input w-full px-4 py-3 rounded-lg" required 
                                       placeholder="Nombre del animal">
                            </div>
                            
                            <div>
                                <label for="animal_tipo" class="block text-sm font-medium form-label mb-2">
                                    Tipo de Animal <span class="text-red-400">*</span>
                                </label>
                                <select id="animal_tipo" name="tipo_de_animal" 
                                        class="form-input w-full px-4 py-3 rounded-lg" required>
                                    <option value="" class="bg-gray-800">Seleccionar tipo</option>
                                    <option value="Perro" class="bg-gray-800">Perro</option>
                                    <option value="Gato" class="bg-gray-800">Gato</option>
                                    <option value="Conejo" class="bg-gray-800">Conejo</option>
                                    <option value="Pájaro" class="bg-gray-800">Pájaro</option>
                                    <option value="Otros" class="bg-gray-800">Otros</option>
                                </select>
                            </div>
                            
                            <!-- CAMPO COLOR PARA CREAR -->
                            <div>
                                <label for="animal_color_select" class="block text-sm font-medium form-label mb-2">
                                    Color <span class="text-red-400">*</span>
                                </label>
                                <div class="space-y-3">
                                    <select id="animal_color_select" name="color_predefinido" 
                                            class="form-input w-full px-4 py-3 rounded-lg" 
                                            onchange="manejarCambioColor()">
                                        <option value="" class="bg-gray-800">Seleccionar color</option>
                                        <option value="Negro" class="bg-gray-800">Negro</option>
                                        <option value="Blanco" class="bg-gray-800">Blanco</option>
                                        <option value="Marrón" class="bg-gray-800">Marrón</option>
                                        <option value="Gris" class="bg-gray-800">Gris</option>
                                        <option value="Dorado" class="bg-gray-800">Dorado</option>
                                        <option value="Rubio" class="bg-gray-800">Rubio</option>
                                        <option value="Rojizo" class="bg-gray-800">Rojizo</option>
                                        <option value="Atigrado" class="bg-gray-800">Atigrado</option>
                                        <option value="Manchado" class="bg-gray-800">Manchado</option>
                                        <option value="Tricolor" class="bg-gray-800">Tricolor</option>
                                        <option value="Bicolor" class="bg-gray-800">Bicolor</option>
                                        <option value="Otro" class="bg-gray-800">Otro (especificar)</option>
                                    </select>
                                    <input type="text" id="animal_color_custom" name="color_personalizado" 
                                           class="form-input w-full px-4 py-3 rounded-lg hidden" 
                                           placeholder="Especifica el color del animal..."
                                           oninput="actualizarColorPersonalizado()">
                                    <input type="hidden" id="animal_color_final" name="color" value="">
                                </div>
                            </div>
                            
                            <div>
                                <label for="animal_raza" class="block text-sm font-medium form-label mb-2">
                                    Raza <span class="text-red-400">*</span>
                                </label>
                                <input type="text" id="animal_raza" name="raza"
                                       class="form-input w-full px-4 py-3 rounded-lg" required
                                       placeholder="Raza del animal">
                            </div>

                            <div>
                                <label for="animal_tamano" class="block text-sm font-medium form-label mb-2">
                                    Tamaño <span class="text-red-400">*</span>
                                </label>
                                <select id="animal_tamano" name="tamano"
                                        class="form-input w-full px-4 py-3 rounded-lg" required>
                                    <option value="" class="bg-gray-800">Seleccionar tamaño</option>
                                    <option value="Mini" class="bg-gray-800">Mini</option>
                                    <option value="Pequeño" class="bg-gray-800">Pequeño</option>
                                    <option value="Mediano-Pequeño" class="bg-gray-800">Mediano-Pequeño</option>
                                    <option value="Mediano" class="bg-gray-800">Mediano</option>
                                    <option value="Mediano-Grande" class="bg-gray-800">Mediano-Grande</option>
                                    <option value="Grande" class="bg-gray-800">Grande</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Multimedia -->
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold text-white mb-4 border-b border-gray-600 pb-2">Multimedia</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium form-label mb-2">Imágenes</label>
                                <!-- Zona de drag and drop para múltiples imágenes -->
                                <label for="modal_imagenes" id="modalDropZone" class="file-upload-btn px-6 py-4 rounded-xl border-2 border-dashed border-gray-600 hover:border-blue-400 transition-all duration-300 group block" style="cursor: pointer;">
                                    <div class="flex flex-col items-center gap-3">
                                        <div class="w-12 h-12 bg-blue-500/20 rounded-xl flex items-center justify-center group-hover:bg-blue-500/30 transition-colors">
                                            <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                            </svg>
                                        </div>
                                        <div class="text-center">
                                            <p class="text-white font-medium">Subir Imágenes</p>
                                            <p class="text-gray-400 text-sm">Arrastra aquí o haz clic para seleccionar</p>
                                            <input type="file"
                                                   id="modal_imagenes"
                                                   name="imagenes"
                                                   accept="image/*"
                                                   multiple
                                                   class="hidden"
                                                   onchange="handleModalImageSelection(this.files)">
                                            <p class="text-xs text-gray-500 mt-2">Máximo 10 imágenes • JPG, PNG, GIF, WebP • Hasta 5MB</p>
                                        </div>
                                    </div>
                                </label>
                                <div id="modalImagePreview" class="grid grid-cols-3 gap-2 mt-3" style="display: none;"></div>
                                <p class="text-xs text-blue-400 mt-2 font-semibold" id="modalImageCounter" style="display: none;">
                                    <span id="modalImageCount">0</span> de 10 imágenes seleccionadas
                                </p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium form-label mb-2">Videos</label>
                                <div class="relative">
                                    <input type="file" id="modal_videos" name="videos" accept="video/*" multiple class="hidden" onchange="handleModalVideoSelection(this.files)">
                                    <button type="button" onclick="document.getElementById('modal_videos').click()"
                                            class="file-upload-btn w-full px-6 py-4 rounded-xl border-2 border-dashed border-gray-600 hover:border-purple-400 transition-all duration-300 group">
                                        <div class="flex flex-col items-center gap-3">
                                            <div class="w-12 h-12 bg-purple-500/20 rounded-xl flex items-center justify-center group-hover:bg-purple-500/30 transition-colors">
                                                <svg class="w-6 h-6 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                                </svg>
                                            </div>
                                            <div class="text-center">
                                                <p class="text-white font-medium">Subir Videos</p>
                                                <p class="text-gray-400 text-sm">Haz clic para seleccionar</p>
                                                <p class="text-xs text-gray-500 mt-1">Máximo 5 videos • MP4, AVI, MOV • Hasta 10MB</p>
                                            </div>
                                        </div>
                                    </button>
                                    <div id="modalVideoPreview" class="grid grid-cols-3 gap-2 mt-3" style="display: none;"></div>
                                    <p class="text-xs text-purple-400 mt-2 font-semibold" id="modalVideoCounter" style="display: none;">
                                        <span id="modalVideoCount">0</span> de 5 videos seleccionados
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Contacto -->
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold text-white mb-4 border-b border-gray-600 pb-2">Información de Contacto</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="animal_email" class="block text-sm font-medium form-label mb-2">
                                    Email <span class="text-red-400">*</span>
                                </label>
                                <input type="email" id="animal_email" name="email" 
                                       class="form-input w-full px-4 py-3 rounded-lg" required 
                                       placeholder="email@ejemplo.com">
                            </div>
                            
                            <div>
                                <label for="animal_telefono" class="block text-sm font-medium form-label mb-2">
                                    Teléfono <span class="text-red-400">*</span>
                                </label>
                                <input type="tel" id="animal_telefono" name="telefono" 
                                       class="form-input w-full px-4 py-3 rounded-lg" required 
                                       placeholder="123456789">
                            </div>
                        </div>
                    </div>

                    <!-- Ubicación -->
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold text-white mb-4 border-b border-gray-600 pb-2">Ubicación</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="animal_poblacion" class="block text-sm font-medium form-label mb-2">
                                    Población <span class="text-red-400">*</span>
                                </label>
                                <input type="text" id="animal_poblacion" name="poblacion" 
                                       class="form-input w-full px-4 py-3 rounded-lg" required 
                                       placeholder="Ciudad">
                            </div>
                            
                            <div>
                                <label for="animal_provincia" class="block text-sm font-medium form-label mb-2">
                                    Provincia <span class="text-red-400">*</span>
                                </label>
                                <input type="text" id="animal_provincia" name="provincia" 
                                       class="form-input w-full px-4 py-3 rounded-lg" required 
                                       placeholder="Provincia">
                            </div>
                            
                            <div>
                                <label for="animal_codigo_postal" class="block text-sm font-medium form-label mb-2">
                                    Código Postal <span class="text-red-400">*</span>
                                </label>
                                <input type="text" id="animal_codigo_postal" name="codigo_postal" 
                                       class="form-input w-full px-4 py-3 rounded-lg" required 
                                       placeholder="12345">
                            </div>
                        </div>
                    </div>

                    <!-- Descripción -->
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold text-white mb-4 border-b border-gray-600 pb-2">Descripción</h3>
                        <div>
                            <label for="animal_descripcion" class="block text-sm font-medium form-label mb-2">
                                Descripción <span class="text-red-400">*</span>
                            </label>
                            <textarea id="animal_descripcion" name="descripcion" rows="4"
                                      class="form-input w-full px-4 py-3 rounded-lg resize-none" required 
                                      placeholder="Cuéntanos sobre este animal especial..."></textarea>
                            <p class="text-gray-500 text-xs mt-1">Máximo 500 caracteres</p>
                        </div>
                    </div>

                    <button type="submit" id="crearAnimalSubmitBtn" class="btn-primary w-full px-6 py-4 rounded-lg font-semibold text-white text-lg">
                        <span class="button-text">Crear Animal</span>
                        <span class="button-loading hidden flex items-center justify-center">
                            <div class="create-spinner-small mr-2"></div>
                            <span class="loading-dots">Procesando</span>
                        </span>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Editar Animal -->
    <div id="editarAnimalModal" class="fixed inset-0 flex items-center justify-center z-50 modal-backdrop hidden">
        <div id="editarAnimalContent" class="modal-content p-8 rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto transform scale-95 opacity-0 transition-all duration-500">
            <button onclick="cerrarEditarAnimal()" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl z-10">&times;</button>
            
            <div id="editarAnimalForm">
                <h2 class="text-3xl font-semibold mb-8 text-center text-white">
                    Editar Animal: <span id="animalNombreEditar"></span>
                </h2>
                
                <!-- Overlay de loading -->
                <div id="editarAnimalLoadingOverlay" class="absolute inset-0 flex items-center justify-center hidden bg-black/80 backdrop-blur-sm rounded-2xl">
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg flex flex-col items-center border border-gray-600">
                        <div class="create-spinner mb-3"></div>
                        <p class="text-white font-medium">Guardando cambios...</p>
                        <p class="text-sm text-gray-400 mt-1">Por favor, no cierres esta ventana</p>
                    </div>
                </div>

                <form method="post" enctype="multipart/form-data" id="editarAnimalFormElement">
                    {% csrf_token %}
                    
                    <!-- Información básica -->
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold text-white mb-4 border-b border-gray-600 pb-2">Información Básica</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="edit_animal_nombre" class="block text-sm font-medium form-label mb-2">
                                    Nombre <span class="text-red-400">*</span>
                                </label>
                                <input type="text" id="edit_animal_nombre" name="nombre" 
                                       class="form-input w-full px-4 py-3 rounded-lg" required 
                                       placeholder="Nombre del animal">
                            </div>
                            
                            <div>
                                <label for="edit_animal_tipo" class="block text-sm font-medium form-label mb-2">
                                    Tipo de Animal <span class="text-red-400">*</span>
                                </label>
                                <select id="edit_animal_tipo" name="tipo_de_animal" 
                                        class="form-input w-full px-4 py-3 rounded-lg" required>
                                    <option value="" class="bg-gray-800">Seleccionar tipo</option>
                                    <option value="Perro" class="bg-gray-800">Perro</option>
                                    <option value="Gato" class="bg-gray-800">Gato</option>
                                    <option value="Conejo" class="bg-gray-800">Conejo</option>
                                    <option value="Pájaro" class="bg-gray-800">Pájaro</option>
                                    <option value="Otros" class="bg-gray-800">Otros</option>
                                </select>
                            </div>
                            
                            <!-- CAMPO COLOR PARA EDITAR -->
                            <div>
                                <label for="edit_animal_color_select" class="block text-sm font-medium form-label mb-2">
                                    Color <span class="text-red-400">*</span>
                                </label>
                                <div class="space-y-3">
                                    <select id="edit_animal_color_select" name="color_predefinido" 
                                            class="form-input w-full px-4 py-3 rounded-lg" 
                                            onchange="manejarCambioColorEditar()">
                                        <option value="" class="bg-gray-800">Seleccionar color</option>
                                        <option value="Negro" class="bg-gray-800">Negro</option>
                                        <option value="Blanco" class="bg-gray-800">Blanco</option>
                                        <option value="Marrón" class="bg-gray-800">Marrón</option>
                                        <option value="Gris" class="bg-gray-800">Gris</option>
                                        <option value="Dorado" class="bg-gray-800">Dorado</option>
                                        <option value="Rubio" class="bg-gray-800">Rubio</option>
                                        <option value="Rojizo" class="bg-gray-800">Rojizo</option>
                                        <option value="Atigrado" class="bg-gray-800">Atigrado</option>
                                        <option value="Manchado" class="bg-gray-800">Manchado</option>
                                        <option value="Tricolor" class="bg-gray-800">Tricolor</option>
                                        <option value="Bicolor" class="bg-gray-800">Bicolor</option>
                                        <option value="Otro" class="bg-gray-800">Otro (especificar)</option>
                                    </select>
                                    <input type="text" id="edit_animal_color_custom" name="color_personalizado" 
                                           class="form-input w-full px-4 py-3 rounded-lg hidden" 
                                           placeholder="Especifica el color del animal..."
                                           oninput="actualizarColorPersonalizadoEditar()">
                                    <input type="hidden" id="edit_animal_color_final" name="color" value="">
                                </div>
                            </div>
                            
                            <div>
                                <label for="edit_animal_raza" class="block text-sm font-medium form-label mb-2">
                                    Raza <span class="text-red-400">*</span>
                                </label>
                                <input type="text" id="edit_animal_raza" name="raza"
                                       class="form-input w-full px-4 py-3 rounded-lg" required
                                       placeholder="Raza del animal">
                            </div>

                            <div>
                                <label for="edit_animal_tamano" class="block text-sm font-medium form-label mb-2">
                                    Tamaño <span class="text-red-400">*</span>
                                </label>
                                <select id="edit_animal_tamano" name="tamano"
                                        class="form-input w-full px-4 py-3 rounded-lg" required>
                                    <option value="" class="bg-gray-800">Seleccionar tamaño</option>
                                    <option value="Mini" class="bg-gray-800">Mini</option>
                                    <option value="Pequeño" class="bg-gray-800">Pequeño</option>
                                    <option value="Mediano-Pequeño" class="bg-gray-800">Mediano-Pequeño</option>
                                    <option value="Mediano" class="bg-gray-800">Mediano</option>
                                    <option value="Mediano-Grande" class="bg-gray-800">Mediano-Grande</option>
                                    <option value="Grande" class="bg-gray-800">Grande</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Multimedia -->
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold text-white mb-4 border-b border-gray-600 pb-2">Imágenes</h3>

                        <!-- Imágenes existentes -->
                        <div id="editImagenesExistentesContainer" class="mb-4">
                            <label class="block text-sm font-medium form-label mb-2">Imágenes actuales</label>
                            <div id="editImagenesExistentes" class="grid grid-cols-3 sm:grid-cols-4 gap-3">
                                <!-- Se llena dinámicamente -->
                            </div>
                            <p id="editNoImagenesMsg" class="text-gray-500 text-sm hidden">No hay imágenes cargadas</p>
                            <p class="text-xs text-gray-400 mt-2">Haz clic en ✕ para marcar una imagen para eliminar</p>
                        </div>

                        <!-- Agregar nuevas imágenes -->
                        <div class="mt-4">
                            <label class="block text-sm font-medium form-label mb-2">Agregar nuevas imágenes</label>
                            <label for="edit_modal_imagenes" id="editModalDropZone" class="file-upload-btn px-6 py-4 rounded-xl border-2 border-dashed border-gray-600 hover:border-blue-400 transition-all duration-300 group block cursor-pointer">
                                <div class="flex flex-col items-center gap-3">
                                    <div class="w-12 h-12 bg-blue-500/20 rounded-xl flex items-center justify-center group-hover:bg-blue-500/30 transition-colors">
                                        <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                        </svg>
                                    </div>
                                    <div class="text-center">
                                        <p class="text-white font-medium">Agregar Imágenes</p>
                                        <p class="text-gray-400 text-sm">Arrastra aquí o haz clic para seleccionar</p>
                                        <input type="file"
                                               id="edit_modal_imagenes"
                                               name="imagenes"
                                               accept="image/*"
                                               multiple
                                               class="hidden"
                                               onchange="handleEditModalImageSelection(this.files)">
                                        <p class="text-xs text-gray-500 mt-2">Máximo 10 imágenes • JPG, PNG, GIF, WebP • Hasta 5MB</p>
                                    </div>
                                </div>
                            </label>
                            <div id="editModalImagePreview" class="grid grid-cols-3 gap-2 mt-3" style="display: none;"></div>
                            <p class="text-xs text-blue-400 mt-2 font-semibold" id="editModalImageCounter" style="display: none;">
                                <span id="editModalImageCount">0</span> nuevas imágenes seleccionadas
                            </p>
                        </div>
                    </div>

                    <!-- Videos -->
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold text-white mb-4 border-b border-gray-600 pb-2">Videos</h3>

                        <!-- Videos existentes -->
                        <div id="editVideosExistentesContainer" class="mb-4">
                            <label class="block text-sm font-medium form-label mb-2">Videos actuales</label>
                            <div id="editVideosExistentes" class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                                <!-- Se llena dinámicamente -->
                            </div>
                            <p id="editNoVideosMsg" class="text-gray-500 text-sm hidden">No hay videos cargados</p>
                        </div>

                        <!-- Agregar nuevos videos -->
                        <div class="mt-4">
                            <label class="block text-sm font-medium form-label mb-2">Agregar nuevos videos</label>
                            <div class="relative">
                                <input type="file" id="edit_modal_videos" name="videos" accept="video/*" multiple class="hidden" onchange="handleEditModalVideoSelection(this.files)">
                                <button type="button" onclick="document.getElementById('edit_modal_videos').click()"
                                        class="file-upload-btn w-full px-6 py-4 rounded-xl border-2 border-dashed border-gray-600 hover:border-purple-400 transition-all duration-300 group">
                                    <div class="flex flex-col items-center gap-3">
                                        <div class="w-12 h-12 bg-purple-500/20 rounded-xl flex items-center justify-center group-hover:bg-purple-500/30 transition-colors">
                                            <svg class="w-6 h-6 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                            </svg>
                                        </div>
                                        <div class="text-center">
                                            <p class="text-white font-medium">Agregar Videos</p>
                                            <p class="text-gray-400 text-sm">Haz clic para seleccionar</p>
                                            <p class="text-xs text-gray-500 mt-1">Máximo 5 videos • MP4, AVI, MOV • Hasta 10MB</p>
                                        </div>
                                    </div>
                                </button>
                                <div id="editModalVideoPreview" class="grid grid-cols-3 gap-2 mt-3" style="display: none;"></div>
                                <p class="text-xs text-purple-400 mt-2 font-semibold" id="editModalVideoCounter" style="display: none;">
                                    <span id="editModalVideoCount">0</span> nuevos videos seleccionados
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Contacto -->
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold text-white mb-4 border-b border-gray-600 pb-2">Información de Contacto</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="edit_animal_email" class="block text-sm font-medium form-label mb-2">
                                    Email <span class="text-red-400">*</span>
                                </label>
                                <input type="email" id="edit_animal_email" name="email" 
                                       class="form-input w-full px-4 py-3 rounded-lg" required 
                                       placeholder="email@ejemplo.com">
                            </div>
                            
                            <div>
                                <label for="edit_animal_telefono" class="block text-sm font-medium form-label mb-2">
                                    Teléfono <span class="text-red-400">*</span>
                                </label>
                                <input type="tel" id="edit_animal_telefono" name="telefono" 
                                       class="form-input w-full px-4 py-3 rounded-lg" required 
                                       placeholder="123456789">
                            </div>
                        </div>
                    </div>

                    <!-- Ubicación -->
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold text-white mb-4 border-b border-gray-600 pb-2">Ubicación</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="edit_animal_poblacion" class="block text-sm font-medium form-label mb-2">
                                    Población <span class="text-red-400">*</span>
                                </label>
                                <input type="text" id="edit_animal_poblacion" name="poblacion" 
                                       class="form-input w-full px-4 py-3 rounded-lg" required 
                                       placeholder="Ciudad">
                            </div>
                            
                            <div>
                                <label for="edit_animal_provincia" class="block text-sm font-medium form-label mb-2">
                                    Provincia <span class="text-red-400">*</span>
                                </label>
                                <input type="text" id="edit_animal_provincia" name="provincia" 
                                       class="form-input w-full px-4 py-3 rounded-lg" required 
                                       placeholder="Provincia">
                            </div>
                            
                            <div>
                                <label for="edit_animal_codigo_postal" class="block text-sm font-medium form-label mb-2">
                                    Código Postal <span class="text-red-400">*</span>
                                </label>
                                <input type="text" id="edit_animal_codigo_postal" name="codigo_postal" 
                                       class="form-input w-full px-4 py-3 rounded-lg" required 
                                       placeholder="12345">
                            </div>
                        </div>
                    </div>

                    <!-- Descripción -->
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold text-white mb-4 border-b border-gray-600 pb-2">Descripción</h3>
                        <div>
                            <label for="edit_animal_descripcion" class="block text-sm font-medium form-label mb-2">
                                Descripción <span class="text-red-400">*</span>
                            </label>
                            <textarea id="edit_animal_descripcion" name="descripcion" rows="4"
                                      class="form-input w-full px-4 py-3 rounded-lg resize-none" required 
                                      placeholder="Cuéntanos sobre este animal especial..."></textarea>
                            <p class="text-gray-500 text-xs mt-1">Máximo 500 caracteres</p>
                        </div>
                    </div>

                    <div class="flex gap-4">
                        <button type="submit" id="editarAnimalSubmitBtn" class="btn-primary flex-1 px-6 py-4 rounded-lg font-semibold text-white text-lg">
                            <span class="button-text">Guardar Cambios</span>
                            <span class="button-loading hidden flex items-center justify-center">
                                <div class="create-spinner-small mr-2"></div>
                                <span class="loading-dots">Guardando</span>
                            </span>
                        </button>
                        <button type="button" onclick="cerrarEditarAnimal()" class="btn-secondary px-6 py-4 rounded-lg font-semibold text-white text-lg">
                            Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmar Eliminación -->
    <div id="confirmarEliminarModal" class="fixed inset-0 flex items-center justify-center z-50 modal-backdrop hidden">
        <div id="confirmarEliminarContent" class="modal-content p-8 rounded-2xl shadow-2xl w-full max-w-md transform scale-95 opacity-0 transition-all duration-500">
            <button onclick="cerrarConfirmarEliminar()" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl z-10">&times;</button>
            
            <div class="text-center">
                <div class="w-16 h-16 mx-auto mb-4 bg-red-500/20 rounded-full flex items-center justify-center">
                    <svg class="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                </div>
                
                <h2 class="text-2xl font-semibold mb-4 text-white">Confirmar Eliminación</h2>
                <p class="text-gray-400 mb-6">
                    ¿Estás seguro de que quieres eliminar a <strong class="text-white" id="nombreAnimalEliminar"></strong>? 
                    <br><span class="text-red-400 text-sm">Esta acción no se puede deshacer.</span>
                </p>
                
                <form method="post" id="formEliminarAnimal">
                    {% csrf_token %}
                    <div class="flex gap-4">
                        <button type="submit" class="btn-danger flex-1 px-6 py-3 rounded-lg font-semibold text-white">
                            Sí, eliminar
                        </button>
                        <button type="button" onclick="cerrarConfirmarEliminar()" class="btn-secondary flex-1 px-6 py-3 rounded-lg font-semibold text-white">
                            Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="navbar-glass fixed top-0 left-0 w-full flex items-center justify-between px-6 py-4 z-40">
        <div class="text-left">
            <h1 class="text-xl font-bold text-white">Adopta</h1>
            {% if request.session.esta_logueado %}
                <p class="text-sm text-gray-400">Hola, {{ request.session.asociacion_nombre }}</p>
            {% endif %}
        </div>

        <div class="flex items-center gap-4">
            <a href="/" class="btn-secondary px-4 py-2 rounded-lg text-sm font-medium text-white">
                Inicio
            </a>
            <button onclick="abrirCrearAnimal()" class="btn-primary px-4 py-2 rounded-lg text-sm font-medium text-white">
                Crear Animal
            </button>
            <a href="/logout/" class="btn-danger px-4 py-2 rounded-lg text-sm font-medium text-white">
                Cerrar Sesión
            </a>
        </div>
    </nav>

    <!-- Contenido principal -->
    <div class="max-w-7xl mx-auto px-6 py-20">
        
        <!-- Título principal -->
        <div class="text-center mb-16 fade-in">
            <h1 class="main-title">
                Mis Animales
            </h1>
            <p class="text-xl text-gray-400 max-w-2xl mx-auto leading-relaxed">
                Gestiona y administra todos los animales de tu asociación
            </p>
        </div>

        <!-- Filtros y buscador -->
        <div class="mb-12 fade-in">
            <!-- Filtros -->
            <div class="filter-container rounded-2xl p-6 mb-8">
                <div class="flex flex-wrap justify-center gap-3 mb-6">
                    <button onclick="filtrarPorTipo('')" 
                            class="filter-btn px-6 py-2 rounded-full text-sm font-medium transition-all duration-300 active" 
                            id="btn-todos">
                        Todos
                    </button>
                    <button onclick="filtrarPorTipo('perro')" 
                            class="filter-btn px-6 py-2 rounded-full text-sm font-medium transition-all duration-300" 
                            id="btn-perro">
                        Perros
                    </button>
                    <button onclick="filtrarPorTipo('gato')" 
                            class="filter-btn px-6 py-2 rounded-full text-sm font-medium transition-all duration-300" 
                            id="btn-gato">
                        Gatos
                    </button>
                    <button onclick="filtrarPorTipo('conejo')" 
                            class="filter-btn px-6 py-2 rounded-full text-sm font-medium transition-all duration-300" 
                            id="btn-conejo">
                        Conejos
                    </button>
                    <button onclick="filtrarPorTipo('pájaro')" 
                            class="filter-btn px-6 py-2 rounded-full text-sm font-medium transition-all duration-300" 
                            id="btn-pájaro">
                        Pájaros
                    </button>
                    <button onclick="filtrarPorTipo('otros')" 
                            class="filter-btn px-6 py-2 rounded-full text-sm font-medium transition-all duration-300" 
                            id="btn-otros">
                        Otros
                    </button>
                </div>
                
                <!-- Buscador -->
                <div class="max-w-md mx-auto relative">
                    <input 
                        type="text" 
                        id="buscadorAnimales" 
                        placeholder="Buscar por nombre, raza..." 
                        class="search-input w-full px-4 py-3 rounded-xl transition-all duration-300 pr-10"
                    >
                    <button onclick="limpiarBusqueda()" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Grid de animales -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8" id="contenedorAnimales">
            {% for animal in mis_animales %}
            <div class="animal-card rounded-2xl overflow-hidden fade-in" 
                 data-nombre="{{ animal.nombre|lower }}" 
                 data-tipo="{{ animal.tipo_de_animal|lower }}"
                 data-raza="{{ animal.raza|lower }}"
                 data-adoptado="{{ animal.adoptado|yesno:'true,false' }}"
                 data-id="{{ animal.id }}">
                
                <div class="card-content relative h-full flex flex-col">
                    
                    <!-- Botones de acción -->
                    <div class="action-buttons">
                        <button onclick="abrirEditarAnimal({{ animal.id }})" class="action-btn edit-btn">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                        </button>
                        <button onclick="abrirConfirmarEliminar({{ animal.id }}, '{{ animal.nombre|escapejs }}')" class="action-btn delete-btn">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- Imagen -->
                    <div class="aspect-[3/4] bg-gray-800 rounded-t-2xl overflow-hidden relative">
                        {% if animal.get_primera_imagen %}
                            <!-- Placeholder animado -->
                            <div class="lazy-placeholder w-full h-full absolute inset-0 flex items-center justify-center text-gray-400">
                                <div class="text-center">
                                    <svg class="animate-spin h-8 w-8 mx-auto mb-2 text-blue-400" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    <p class="text-sm text-blue-400">Cargando...</p>
                                </div>
                            </div>
                            <!-- Imagen lazy -->
                            <img
                                data-src="{{ animal.get_primera_imagen }}"
                                alt="Imagen de {{ animal.nombre }}"
                                class="lazy-image w-full h-full object-cover absolute inset-0 transition-transform duration-500 hover:scale-110"
                                loading="lazy"
                            >
                        {% else %}
                            <div class="w-full h-full flex items-center justify-center text-gray-500">
                                <svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Información -->
                    <div class="p-6 flex-grow flex flex-col">
                        <h3 class="text-2xl font-bold text-white mb-2 tracking-wide">{{ animal.nombre }}</h3>
                        <p class="text-blue-300 font-medium text-sm uppercase tracking-wider mb-1 opacity-90">{{ animal.raza }}</p>
                        <p class="text-gray-400 text-xs uppercase tracking-wide mb-3 opacity-75">Tamaño: {{ animal.tamano }}</p>

                        <div class="flex items-center justify-between mb-4">
                            <span class="text-gray-400 text-sm">Estado:</span>
                            <span class="estado-badge {% if animal.adoptado %}badge-adoptado{% else %}badge-disponible{% endif %}">
                                <span class="estado-texto">{% if animal.adoptado %}Adoptado{% else %}Disponible{% endif %}</span>
                            </span>
                        </div>
                        
                        <!-- Botón de cambio de estado -->
                        <div class="mt-auto">
                            <button onclick="toggleEstado({{ animal.id }}, {{ animal.adoptado|yesno:'true,false' }})" 
                                    class="toggle-btn {% if animal.adoptado %}btn-primary{% else %}btn-danger{% endif %} w-full px-4 py-2 rounded-lg text-sm font-medium text-white transition-all">
                                <span class="btn-texto">Marcar como {% if animal.adoptado %}Disponible{% else %}Adoptado{% endif %}</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="col-span-full text-center text-gray-400 text-lg">
                <div class="bg-gray-800/20 border border-gray-700/50 rounded-2xl p-12 backdrop-blur-10">
                    <svg class="w-16 h-16 mx-auto mb-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    <p class="text-xl mb-2">No has añadido ningún animal todavía</p>
                    <button onclick="abrirCrearAnimal()" class="btn-primary inline-block px-6 py-2 rounded-lg text-sm font-medium text-white">
                        Añade tu primer animal
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

</div>

<script>
    // ========== DATOS DE ANIMALES PARA EDITAR ==========
    let animalesData = {
        {% for animal in mis_animales %}
        {{ animal.id }}: {
            id: {{ animal.id }},
            nombre: "{{ animal.nombre|escapejs }}",
            tipo_de_animal: "{{ animal.tipo_de_animal|escapejs }}",
            raza: "{{ animal.raza|escapejs }}",
            tamano: "{{ animal.tamano|escapejs }}",
            color: "{{ animal.color|escapejs }}",
            email: "{{ animal.email|escapejs }}",
            telefono: "{{ animal.telefono|escapejs }}",
            poblacion: "{{ animal.poblacion|escapejs }}",
            provincia: "{{ animal.provincia|escapejs }}",
            codigo_postal: "{{ animal.codigo_postal|escapejs }}",
            descripcion: "{{ animal.descripcion|escapejs }}",
            imagen: "{% if animal.get_primera_imagen %}{{ animal.get_primera_imagen }}{% endif %}",
            imagenes: [
                {% for img in animal.imagenes.all %}
                {id: {{ img.id }}, url: "{{ img.imagen }}", es_principal: {{ img.es_principal|yesno:"true,false" }}}{% if not forloop.last %},{% endif %}
                {% endfor %}
            ],
            videos: [
                {% for vid in animal.videos.all %}
                {id: {{ vid.id }}, url: "{{ vid.video }}"}{% if not forloop.last %},{% endif %}
                {% endfor %}
            ]
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    };

    // ========== FUNCIONES PARA MANEJO DE COLOR CREAR ==========
    function manejarCambioColor() {
        const colorSelect = document.getElementById('animal_color_select');
        const colorCustom = document.getElementById('animal_color_custom');
        const colorFinal = document.getElementById('animal_color_final');
        
        if (colorSelect.value === 'Otro') {
            colorCustom.classList.remove('hidden');
            colorCustom.setAttribute('required', 'required');
            colorCustom.focus();
            colorFinal.value = '';
        } else if (colorSelect.value === '') {
            colorCustom.classList.add('hidden');
            colorCustom.removeAttribute('required');
            colorCustom.value = '';
            colorFinal.value = '';
        } else {
            colorCustom.classList.add('hidden');
            colorCustom.removeAttribute('required');
            colorCustom.value = '';
            colorFinal.value = colorSelect.value;
        }
    }

    function actualizarColorPersonalizado() {
        const colorCustom = document.getElementById('animal_color_custom');
        const colorFinal = document.getElementById('animal_color_final');
        
        if (colorCustom && colorFinal) {
            colorFinal.value = colorCustom.value.trim();
        }
    }

    function resetColorSelector() {
        const colorSelect = document.getElementById('animal_color_select');
        const colorCustom = document.getElementById('animal_color_custom');
        const colorFinal = document.getElementById('animal_color_final');
        
        if (colorSelect) colorSelect.value = '';
        if (colorCustom) {
            colorCustom.classList.add('hidden');
            colorCustom.removeAttribute('required');
            colorCustom.value = '';
        }
        if (colorFinal) colorFinal.value = '';
    }

    function validarColorAntesDelEnvio() {
        const colorSelect = document.getElementById('animal_color_select');
        const colorCustom = document.getElementById('animal_color_custom');
        const colorFinal = document.getElementById('animal_color_final');
        
        if (colorSelect.value === '') {
            alert('Por favor, selecciona un color para el animal.');
            colorSelect.focus();
            return false;
        }
        
        if (colorSelect.value === 'Otro' && (!colorCustom.value || colorCustom.value.trim() === '')) {
            alert('Por favor, especifica el color del animal.');
            colorCustom.focus();
            return false;
        }
        
        if (!colorFinal.value || colorFinal.value.trim() === '') {
            manejarCambioColor();
            if (!colorFinal.value || colorFinal.value.trim() === '') {
                alert('Error al procesar el color. Por favor, intenta de nuevo.');
                return false;
            }
        }
        
        return true;
    }

    // ========== FUNCIONES PARA MANEJO DE COLOR EDITAR ==========
    function manejarCambioColorEditar() {
        const colorSelect = document.getElementById('edit_animal_color_select');
        const colorCustom = document.getElementById('edit_animal_color_custom');
        const colorFinal = document.getElementById('edit_animal_color_final');
        
        if (colorSelect.value === 'Otro') {
            colorCustom.classList.remove('hidden');
            colorCustom.setAttribute('required', 'required');
            colorCustom.focus();
            colorFinal.value = '';
        } else if (colorSelect.value === '') {
            colorCustom.classList.add('hidden');
            colorCustom.removeAttribute('required');
            colorCustom.value = '';
            colorFinal.value = '';
        } else {
            colorCustom.classList.add('hidden');
            colorCustom.removeAttribute('required');
            colorCustom.value = '';
            colorFinal.value = colorSelect.value;
        }
    }

    function actualizarColorPersonalizadoEditar() {
        const colorCustom = document.getElementById('edit_animal_color_custom');
        const colorFinal = document.getElementById('edit_animal_color_final');
        
        if (colorCustom && colorFinal) {
            colorFinal.value = colorCustom.value.trim();
        }
    }

    function resetColorSelectorEditar() {
        const colorSelect = document.getElementById('edit_animal_color_select');
        const colorCustom = document.getElementById('edit_animal_color_custom');
        const colorFinal = document.getElementById('edit_animal_color_final');
        
        if (colorSelect) colorSelect.value = '';
        if (colorCustom) {
            colorCustom.classList.add('hidden');
            colorCustom.removeAttribute('required');
            colorCustom.value = '';
        }
        if (colorFinal) colorFinal.value = '';
    }

    function validarColorAntesDelEnvioEditar() {
        const colorSelect = document.getElementById('edit_animal_color_select');
        const colorCustom = document.getElementById('edit_animal_color_custom');
        const colorFinal = document.getElementById('edit_animal_color_final');
        
        if (colorSelect.value === '') {
            alert('Por favor, selecciona un color para el animal.');
            colorSelect.focus();
            return false;
        }
        
        if (colorSelect.value === 'Otro' && (!colorCustom.value || colorCustom.value.trim() === '')) {
            alert('Por favor, especifica el color del animal.');
            colorCustom.focus();
            return false;
        }
        
        if (!colorFinal.value || colorFinal.value.trim() === '') {
            manejarCambioColorEditar();
            if (!colorFinal.value || colorFinal.value.trim() === '') {
                alert('Error al procesar el color. Por favor, intenta de nuevo.');
                return false;
            }
        }
        
        return true;
    }

    function configurarColorEditar(colorActual) {
        const colorSelect = document.getElementById('edit_animal_color_select');
        const colorCustom = document.getElementById('edit_animal_color_custom');
        const colorFinal = document.getElementById('edit_animal_color_final');
        
        // Lista de colores predefinidos
        const coloresPredefinidos = ['Negro', 'Blanco', 'Marrón', 'Gris', 'Dorado', 'Rubio', 'Rojizo', 'Atigrado', 'Manchado', 'Tricolor', 'Bicolor'];
        
        if (coloresPredefinidos.includes(colorActual)) {
            // Color predefinido
            colorSelect.value = colorActual;
            colorFinal.value = colorActual;
        } else {
            // Color personalizado
            colorSelect.value = 'Otro';
            colorCustom.classList.remove('hidden');
            colorCustom.setAttribute('required', 'required');
            colorCustom.value = colorActual;
            colorFinal.value = colorActual;
        }
    }

    // ========== ESTRELLAS ==========
    function crearEstrellas() {
        const starfield = document.getElementById('starfield');
        const numStars = 150;
        
        for (let i = 0; i < numStars; i++) {
            const star = document.createElement('div');
            star.className = 'star';
            
            if (Math.random() < 0.1) star.classList.add('large');
            if (Math.random() < 0.05) star.classList.add('bright');
            
            star.style.left = Math.random() * 100 + '%';
            star.style.top = Math.random() * 100 + '%';
            star.style.animationDelay = Math.random() * 3 + 's';
            
            starfield.appendChild(star);
        }
        
        setInterval(() => {
            if (Math.random() < 0.3) {
                const shootingStar = document.createElement('div');
                shootingStar.className = 'shooting-star';
                shootingStar.style.left = Math.random() * 100 + '%';
                shootingStar.style.top = Math.random() * 100 + '%';
                
                starfield.appendChild(shootingStar);
                
                setTimeout(() => {
                    if (shootingStar.parentNode) {
                        shootingStar.remove();
                    }
                }, 2000);
            }
        }, 3000);
    }

    // ========== TOGGLE ESTADO ADOPCIÓN ==========
    async function toggleEstado(animalId, adoptadoActual) {
        const card = document.querySelector(`[data-id="${animalId}"]`);
        const estadoBadge = card.querySelector('.estado-badge');
        const estadoTexto = card.querySelector('.estado-texto');
        const toggleBtn = card.querySelector('.toggle-btn');
        const btnTexto = card.querySelector('.btn-texto');
        
        // Mostrar loading
        toggleBtn.innerHTML = '<div class="create-spinner-small"></div>';
        toggleBtn.disabled = true;
        
        try {
            const response = await fetch(`/toggle_adopcion/${animalId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '',
                    'Content-Type': 'application/json',
                },
            });
            
            if (response.ok) {
                const data = await response.json();
                const nuevoEstado = data.adoptado;
                
                // Actualizar atributo del card
                card.setAttribute('data-adoptado', nuevoEstado ? 'true' : 'false');
                
                // Actualizar badge
                if (nuevoEstado) {
                    estadoBadge.className = 'estado-badge badge-adoptado';
                    estadoTexto.textContent = 'Adoptado';
                } else {
                    estadoBadge.className = 'estado-badge badge-disponible';
                    estadoTexto.textContent = 'Disponible';
                }
                
                // Actualizar botón
                if (nuevoEstado) {
                    toggleBtn.className = 'toggle-btn btn-primary w-full px-4 py-2 rounded-lg text-sm font-medium text-white transition-all';
                    btnTexto.textContent = 'Marcar como Disponible';
                } else {
                    toggleBtn.className = 'toggle-btn btn-danger w-full px-4 py-2 rounded-lg text-sm font-medium text-white transition-all';
                    btnTexto.textContent = 'Marcar como Adoptado';
                }
                
                // Restaurar texto del botón
                toggleBtn.innerHTML = `<span class="btn-texto">${btnTexto.textContent}</span>`;
                toggleBtn.disabled = false;
                
            } else {
                throw new Error('Error en la respuesta del servidor');
            }
        } catch (error) {
            console.error('Error al cambiar estado:', error);
            // Restaurar botón en caso de error
            toggleBtn.innerHTML = `<span class="btn-texto">Marcar como ${adoptadoActual ? 'Disponible' : 'Adoptado'}</span>`;
            toggleBtn.disabled = false;
            alert('Error al cambiar el estado. Por favor, intenta de nuevo.');
        }
    }

    // ========== MODAL CONFIRMAR ELIMINACIÓN ==========
    function abrirConfirmarEliminar(animalId, nombreAnimal) {
        const modal = document.getElementById('confirmarEliminarModal');
        const content = document.getElementById('confirmarEliminarContent');
        const nombreSpan = document.getElementById('nombreAnimalEliminar');
        const form = document.getElementById('formEliminarAnimal');
        
        // Configurar el modal
        nombreSpan.textContent = nombreAnimal;
        form.action = `/eliminar_animal/${animalId}/`;
        
        // Mostrar modal
        modal.classList.remove('hidden');
        setTimeout(() => {
            content.classList.remove('scale-95', 'opacity-0');
            content.classList.add('scale-100', 'opacity-100');
        }, 10);
    }

    function cerrarConfirmarEliminar() {
        const modal = document.getElementById('confirmarEliminarModal');
        const content = document.getElementById('confirmarEliminarContent');
        
        content.classList.remove('scale-100', 'opacity-100');
        content.classList.add('scale-95', 'opacity-0');
        
        setTimeout(() => {
            modal.classList.add('hidden');
        }, 500);
    }

    // ========== MODAL CREAR ANIMAL ==========
    function abrirCrearAnimal() {
        const modal = document.getElementById('crearAnimalModal');
        const content = document.getElementById('crearAnimalContent');
        
        modal.classList.remove('hidden');
        setTimeout(() => {
            content.classList.remove('scale-95', 'opacity-0');
            content.classList.add('scale-100', 'opacity-100');
        }, 10);
    }

    function cerrarCrearAnimal() {
        const modal = document.getElementById('crearAnimalModal');
        const content = document.getElementById('crearAnimalContent');

        content.classList.remove('scale-100', 'opacity-100');
        content.classList.add('scale-95', 'opacity-0');

        setTimeout(() => {
            modal.classList.add('hidden');
            resetCrearAnimalForm();
            // Limpiar las imágenes y videos seleccionados
            modalSelectedImages = [];
            modalSelectedVideos = [];
            updateModalImagePreview();
            updateModalVideoPreview();
        }, 500);
    }

    // ========== MODAL EDITAR ANIMAL ==========
    function abrirEditarAnimal(animalId) {
        const animal = animalesData[animalId];
        if (!animal) {
            alert('Error: No se encontró el animal');
            return;
        }

        // Resetear el modal antes de cargar nuevos datos
        resetEditModal();

        // Llenar formulario con datos del animal
        document.getElementById('animalNombreEditar').textContent = animal.nombre;
        document.getElementById('edit_animal_nombre').value = animal.nombre;
        document.getElementById('edit_animal_tipo').value = animal.tipo_de_animal;
        document.getElementById('edit_animal_raza').value = animal.raza;
        document.getElementById('edit_animal_tamano').value = animal.tamano;
        document.getElementById('edit_animal_email').value = animal.email;
        document.getElementById('edit_animal_telefono').value = animal.telefono;
        document.getElementById('edit_animal_poblacion').value = animal.poblacion;
        document.getElementById('edit_animal_provincia').value = animal.provincia;
        document.getElementById('edit_animal_codigo_postal').value = animal.codigo_postal;
        document.getElementById('edit_animal_descripcion').value = animal.descripcion;

        // Configurar el color
        configurarColorEditar(animal.color || 'No especificado');

        // Cargar imágenes existentes del animal
        loadExistingImages(animal.imagenes || []);

        // Cargar videos existentes del animal
        loadExistingVideos(animal.videos || []);

        // Configurar la acción del formulario
        const form = document.getElementById('editarAnimalFormElement');
        form.action = `/editar_animal/${animalId}/`;

        // Mostrar modal
        const modal = document.getElementById('editarAnimalModal');
        const content = document.getElementById('editarAnimalContent');

        modal.classList.remove('hidden');
        setTimeout(() => {
            content.classList.remove('scale-95', 'opacity-0');
            content.classList.add('scale-100', 'opacity-100');
            // Configurar drag and drop después de mostrar el modal
            setupEditModalDragAndDrop();
        }, 10);
    }

    function cerrarEditarAnimal() {
        const modal = document.getElementById('editarAnimalModal');
        const content = document.getElementById('editarAnimalContent');

        content.classList.remove('scale-100', 'opacity-100');
        content.classList.add('scale-95', 'opacity-0');

        setTimeout(() => {
            modal.classList.add('hidden');
            resetEditarAnimalForm();
            resetEditModal();
        }, 500);
    }

    function resetCrearAnimalForm() {
        const form = document.getElementById('crearAnimalFormElement');
        if (form) form.reset();
        
        setCrearAnimalButtonLoading(false);
        showCrearAnimalOverlay(false);
        
        quitarImagen();
        quitarVideo();
        resetColorSelector();
    }

    function resetEditarAnimalForm() {
        const form = document.getElementById('editarAnimalFormElement');
        if (form) form.reset();
        
        setEditarAnimalButtonLoading(false);
        showEditarAnimalOverlay(false);
        
        quitarImagenEditar();
        quitarVideoEditar();
        resetColorSelectorEditar();
        
        // Ocultar imagen actual
        document.getElementById('imagenActualContainer').classList.add('hidden');
    }

    function setCrearAnimalButtonLoading(loading = true) {
        const button = document.getElementById('crearAnimalSubmitBtn');
        if (!button) return;
        
        const textSpan = button.querySelector('.button-text');
        const loadingSpan = button.querySelector('.button-loading');
        
        if (loading) {
            if (textSpan) textSpan.classList.add('hidden');
            if (loadingSpan) loadingSpan.classList.remove('hidden');
            button.disabled = true;
            button.classList.add('opacity-75', 'cursor-not-allowed');
        } else {
            if (textSpan) textSpan.classList.remove('hidden');
            if (loadingSpan) loadingSpan.classList.add('hidden');
            button.disabled = false;
            button.classList.remove('opacity-75', 'cursor-not-allowed');
        }
    }

    function setEditarAnimalButtonLoading(loading = true) {
        const button = document.getElementById('editarAnimalSubmitBtn');
        if (!button) return;
        
        const textSpan = button.querySelector('.button-text');
        const loadingSpan = button.querySelector('.button-loading');
        
        if (loading) {
            if (textSpan) textSpan.classList.add('hidden');
            if (loadingSpan) loadingSpan.classList.remove('hidden');
            button.disabled = true;
            button.classList.add('opacity-75', 'cursor-not-allowed');
        } else {
            if (textSpan) textSpan.classList.remove('hidden');
            if (loadingSpan) loadingSpan.classList.add('hidden');
            button.disabled = false;
            button.classList.remove('opacity-75', 'cursor-not-allowed');
        }
    }

    function showCrearAnimalOverlay(show = true) {
        const overlay = document.getElementById('crearAnimalLoadingOverlay');
        if (overlay) {
            if (show) {
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }
    }

    function showEditarAnimalOverlay(show = true) {
        const overlay = document.getElementById('editarAnimalLoadingOverlay');
        if (overlay) {
            if (show) {
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }
    }

    function initFileIndicators() {
        // Indicadores para crear animal
        const imagenInput = document.getElementById('animal_imagen');
        const videoInput = document.getElementById('animal_video');

        if (imagenInput) {
            imagenInput.addEventListener('change', function(e) {
                const statusDiv = document.getElementById('imagenStatus');
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    const fileName = file.name;
                    const fileSize = (file.size / (1024 * 1024)).toFixed(2);
                    
                    if (statusDiv) {
                        statusDiv.innerHTML = `
                            <div class="file-indicator flex items-center justify-between">
                                <div>
                                    <span class="text-green-400">✓ Imagen: ${fileName}</span>
                                    <span class="text-xs text-gray-400 block">${fileSize} MB</span>
                                </div>
                                <button type="button" onclick="quitarImagen()" 
                                        class="ml-3 text-red-400 hover:text-red-300 transition-colors duration-200 text-sm font-medium flex items-center gap-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                    Quitar
                                </button>
                            </div>
                        `;
                        statusDiv.classList.remove('hidden');
                    }
                } else {
                    if (statusDiv) {
                        statusDiv.classList.add('hidden');
                        statusDiv.innerHTML = '';
                    }
                }
            });
        }

        if (videoInput) {
            videoInput.addEventListener('change', function(e) {
                const statusDiv = document.getElementById('videoStatus');
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    const fileName = file.name;
                    const fileSize = (file.size / (1024 * 1024)).toFixed(2);
                    
                    if (statusDiv) {
                        statusDiv.innerHTML = `
                            <div class="file-indicator flex items-center justify-between">
                                <div>
                                    <span class="text-green-400">✓ Video: ${fileName}</span>
                                    <span class="text-xs text-gray-400 block">${fileSize} MB</span>
                                </div>
                                <button type="button" onclick="quitarVideo()" 
                                        class="ml-3 text-red-400 hover:text-red-300 transition-colors duration-200 text-sm font-medium flex items-center gap-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                    Quitar
                                </button>
                            </div>
                        `;
                        statusDiv.classList.remove('hidden');
                    }
                } else {
                    if (statusDiv) {
                        statusDiv.classList.add('hidden');
                        statusDiv.innerHTML = '';
                    }
                }
            });
        }

        // Indicadores para editar animal
        const editImagenInput = document.getElementById('edit_animal_imagen');
        const editVideoInput = document.getElementById('edit_animal_video');

        if (editImagenInput) {
            editImagenInput.addEventListener('change', function(e) {
                const statusDiv = document.getElementById('editImagenStatus');
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    const fileName = file.name;
                    const fileSize = (file.size / (1024 * 1024)).toFixed(2);
                    
                    if (statusDiv) {
                        statusDiv.innerHTML = `
                            <div class="file-indicator flex items-center justify-between">
                                <div>
                                    <span class="text-green-400">✓ Nueva imagen: ${fileName}</span>
                                    <span class="text-xs text-gray-400 block">${fileSize} MB</span>
                                </div>
                                <button type="button" onclick="quitarImagenEditar()" 
                                        class="ml-3 text-red-400 hover:text-red-300 transition-colors duration-200 text-sm font-medium flex items-center gap-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                    Quitar
                                </button>
                            </div>
                        `;
                        statusDiv.classList.remove('hidden');
                    }
                } else {
                    if (statusDiv) {
                        statusDiv.classList.add('hidden');
                        statusDiv.innerHTML = '';
                    }
                }
            });
        }

        if (editVideoInput) {
            editVideoInput.addEventListener('change', function(e) {
                const statusDiv = document.getElementById('editVideoStatus');
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    const fileName = file.name;
                    const fileSize = (file.size / (1024 * 1024)).toFixed(2);
                    
                    if (statusDiv) {
                        statusDiv.innerHTML = `
                            <div class="file-indicator flex items-center justify-between">
                                <div>
                                    <span class="text-green-400">✓ Nuevo video: ${fileName}</span>
                                    <span class="text-xs text-gray-400 block">${fileSize} MB</span>
                                </div>
                                <button type="button" onclick="quitarVideoEditar()" 
                                        class="ml-3 text-red-400 hover:text-red-300 transition-colors duration-200 text-sm font-medium flex items-center gap-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                    Quitar
                                </button>
                            </div>
                        `;
                        statusDiv.classList.remove('hidden');
                    }
                } else {
                    if (statusDiv) {
                        statusDiv.classList.add('hidden');
                        statusDiv.innerHTML = '';
                    }
                }
            });
        }
    }

    function quitarImagen() {
        const imagenInput = document.getElementById('animal_imagen');
        const statusDiv = document.getElementById('imagenStatus');
        
        if (imagenInput) {
            imagenInput.value = '';
        }
        
        if (statusDiv) {
            statusDiv.classList.add('hidden');
            statusDiv.innerHTML = '';
        }
    }

    function quitarVideo() {
        const videoInput = document.getElementById('animal_video');
        const statusDiv = document.getElementById('videoStatus');
        
        if (videoInput) {
            videoInput.value = '';
        }
        
        if (statusDiv) {
            statusDiv.classList.add('hidden');
            statusDiv.innerHTML = '';
        }
    }

    function quitarImagenEditar() {
        const imagenInput = document.getElementById('edit_animal_imagen');
        const statusDiv = document.getElementById('editImagenStatus');
        
        if (imagenInput) {
            imagenInput.value = '';
        }
        
        if (statusDiv) {
            statusDiv.classList.add('hidden');
            statusDiv.innerHTML = '';
        }
    }

    function quitarVideoEditar() {
        const videoInput = document.getElementById('edit_animal_video');
        const statusDiv = document.getElementById('editVideoStatus');
        
        if (videoInput) {
            videoInput.value = '';
        }
        
        if (statusDiv) {
            statusDiv.classList.add('hidden');
            statusDiv.innerHTML = '';
        }
    }

    // ========== LAZY LOADING ==========
    class LazyImageLoader {
        constructor() {
            this.imageObserver = null;
            this.init();
        }

        init() {
            if ('IntersectionObserver' in window) {
                this.imageObserver = new IntersectionObserver((entries, observer) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            this.loadImage(img);
                            observer.unobserve(img);
                        }
                    });
                }, {
                    rootMargin: '50px 0px',
                    threshold: 0.01
                });

                this.observeImages();
            } else {
                this.loadAllImages();
            }
        }

        observeImages() {
            const lazyImages = document.querySelectorAll('.lazy-image[data-src]');
            lazyImages.forEach(img => {
                this.imageObserver.observe(img);
            });
        }

        loadImage(img) {
            const placeholder = img.parentElement.querySelector('.lazy-placeholder');
            const imageLoader = new Image();
            
            imageLoader.onload = () => {
                img.src = img.dataset.src;
                img.classList.add('loaded');
                
                if (placeholder) {
                    placeholder.style.opacity = '0';
                    setTimeout(() => {
                        placeholder.style.display = 'none';
                    }, 300);
                }
                
                img.removeAttribute('data-src');
            };
            
            imageLoader.onerror = () => {
                if (placeholder) {
                    placeholder.innerHTML = `
                        <div class="text-center text-gray-400">
                            <svg class="h-12 w-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <p class="text-sm">Error al cargar imagen</p>
                        </div>
                    `;
                }
                img.removeAttribute('data-src');
            };
            
            imageLoader.src = img.dataset.src;
        }

        loadAllImages() {
            const lazyImages = document.querySelectorAll('.lazy-image[data-src]');
            lazyImages.forEach(img => {
                this.loadImage(img);
            });
        }

        refreshObserver() {
            if (this.imageObserver) {
                this.observeImages();
            }
        }
    }

    // ========== FILTROS ==========
    let filtroActual = '';
    let lazyLoader;

    function filtrarPorTipo(tipo) {
        filtroActual = tipo;
        
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        if (tipo === '') {
            document.getElementById('btn-todos').classList.add('active');
        } else {
            document.getElementById('btn-' + tipo).classList.add('active');
        }
        
        aplicarFiltros();
    }

    function aplicarFiltros() {
        const busqueda = document.getElementById('buscadorAnimales').value.toLowerCase();
        const animales = document.querySelectorAll('.animal-card');
        let contador = 0;
        
        animales.forEach(animal => {
            const nombre = animal.dataset.nombre;
            const tipo = animal.dataset.tipo;
            const raza = animal.dataset.raza;
            
            const cumpleBusqueda = !busqueda || 
                nombre.includes(busqueda) || 
                tipo.includes(busqueda) || 
                raza.includes(busqueda);
            
            let cumpleTipo = true;
            if (filtroActual !== '') {
                if (filtroActual === 'otros') {
                    cumpleTipo = !tipo.includes('perro') && 
                                !tipo.includes('gato') && 
                                !tipo.includes('conejo') && 
                                !tipo.includes('pájaro');
                } else {
                    cumpleTipo = tipo.includes(filtroActual);
                }
            }
            
            if (cumpleBusqueda && cumpleTipo) {
                animal.style.display = 'block';
                contador++;
            } else {
                animal.style.display = 'none';
            }
        });
        
        if (lazyLoader) {
            setTimeout(() => lazyLoader.refreshObserver(), 100);
        }
    }

    function limpiarBusqueda() {
        document.getElementById('buscadorAnimales').value = '';
        aplicarFiltros();
    }

    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // ========== INICIALIZACIÓN ==========
    document.addEventListener('DOMContentLoaded', function() {
        crearEstrellas();
        lazyLoader = new LazyImageLoader();
        
        document.getElementById('buscadorAnimales').addEventListener('input', debounce(aplicarFiltros, 300));
        
        // Event listeners para formularios
        const crearForm = document.getElementById('crearAnimalFormElement');
        if (crearForm) {
            crearForm.addEventListener('submit', function(e) {
                if (!validarColorAntesDelEnvio()) {
                    e.preventDefault();
                    return false;
                }
                setCrearAnimalButtonLoading(true);
                showCrearAnimalOverlay(true);
            });
        }

        const editarForm = document.getElementById('editarAnimalFormElement');
        if (editarForm) {
            editarForm.addEventListener('submit', function(e) {
                if (!validarColorAntesDelEnvioEditar()) {
                    e.preventDefault();
                    return false;
                }
                setEditarAnimalButtonLoading(true);
                showEditarAnimalOverlay(true);
            });
        }
        
        // Inicializar indicadores de archivos
        initFileIndicators();
        
        // Cerrar modales al hacer clic fuera
        document.getElementById('crearAnimalModal').addEventListener('click', function(e) {
            if (e.target === this) cerrarCrearAnimal();
        });

        document.getElementById('editarAnimalModal').addEventListener('click', function(e) {
            if (e.target === this) cerrarEditarAnimal();
        });

        document.getElementById('confirmarEliminarModal').addEventListener('click', function(e) {
            if (e.target === this) cerrarConfirmarEliminar();
        });
        
        // Animación de entrada
        setTimeout(() => {
            document.querySelectorAll('.fade-in').forEach((el, i) => {
                setTimeout(() => {
                    el.style.opacity = '1';
                    el.style.transform = 'translateY(0)';
                }, i * 100);
            });
        }, 200);
    });

    // ========== FUNCIONES PARA MÚLTIPLES IMÁGENES Y VIDEOS EN MODAL ==========
    let modalSelectedImages = [];
    let modalSelectedVideos = [];

    // Manejar selección de imágenes en el modal
    function handleModalImageSelection(files) {
        const imageFiles = Array.from(files).filter(file => file.type.startsWith('image/'));

        // Verificar cuántas imágenes podemos agregar
        const espacioDisponible = 10 - modalSelectedImages.length;

        if (espacioDisponible === 0) {
            showModalNotification('⚠️ Ya has alcanzado el máximo de 10 imágenes', 'warning');
            return;
        }

        if (imageFiles.length > espacioDisponible) {
            showModalNotification(`⚠️ Solo puedes agregar ${espacioDisponible} imagen(es) más`, 'warning');
            imageFiles.splice(espacioDisponible);
        }

        // Validar tamaño de archivos (5MB max)
        const validFiles = imageFiles.filter(file => {
            // Verificar que no sea un archivo duplicado
            const isDuplicate = modalSelectedImages.some(existingFile =>
                existingFile.name === file.name &&
                existingFile.size === file.size &&
                existingFile.lastModified === file.lastModified
            );

            if (isDuplicate) {
                showModalNotification(`⚠️ ${file.name} ya fue agregada`, 'warning');
                return false;
            }

            if (file.size > 5 * 1024 * 1024) {
                showModalNotification(`❌ ${file.name} es demasiado grande (máx. 5MB)`, 'error');
                return false;
            }
            return true;
        });

        if (validFiles.length > 0) {
            modalSelectedImages.push(...validFiles);
            showModalNotification(`✅ ${validFiles.length} imagen(es) agregada(s)`, 'success');
            updateModalImagePreview();
            updateModalImageInput();
        }
    }

    // Actualizar preview de imágenes en el modal
    function updateModalImagePreview() {
        const preview = document.getElementById('modalImagePreview');
        const dropZone = document.getElementById('modalDropZone');
        const counter = document.getElementById('modalImageCounter');
        const count = document.getElementById('modalImageCount');

        if (!preview || !dropZone || !counter || !count) return;

        if (modalSelectedImages.length === 0) {
            // Restaurar la zona de drop completa
            dropZone.innerHTML = `
                <div class="flex flex-col items-center gap-3">
                    <div class="w-12 h-12 bg-blue-500/20 rounded-xl flex items-center justify-center group-hover:bg-blue-500/30 transition-colors">
                        <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                    </div>
                    <div class="text-center">
                        <p class="text-white font-medium">Subir Imágenes</p>
                        <p class="text-gray-400 text-sm">Arrastra aquí o
                            <label for="modal_imagenes" class="text-blue-400 hover:text-blue-500 cursor-pointer">
                                haz clic para seleccionar
                            </label>
                        </p>
                        <input type="file" id="modal_imagenes" name="imagenes" accept="image/*" multiple class="hidden" onchange="handleModalImageSelection(this.files)">
                        <p class="text-xs text-gray-500 mt-2">Máximo 10 imágenes • JPG, PNG, GIF, WebP • Hasta 5MB</p>
                    </div>
                </div>
            `;
            preview.style.display = 'none';
            counter.style.display = 'none';
            return;
        }

        // Mostrar botón más pequeño para agregar más
        if (modalSelectedImages.length < 10) {
            dropZone.innerHTML = `
                <div class="flex items-center justify-center gap-2">
                    <span class="text-sm text-blue-400">➕ Agregar más</span>
                    <label for="modal_imagenes" class="text-sm text-blue-400 hover:text-blue-500 cursor-pointer underline">
                        Seleccionar
                    </label>
                    <input type="file" id="modal_imagenes" name="imagenes" accept="image/*" multiple class="hidden" onchange="handleModalImageSelection(this.files)">
                </div>
            `;
            dropZone.classList.add('py-2');
        } else {
            dropZone.style.display = 'none';
        }

        preview.style.display = 'grid';
        counter.style.display = 'block';
        count.textContent = modalSelectedImages.length;

        preview.innerHTML = '';

        modalSelectedImages.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const div = document.createElement('div');
                div.className = 'relative rounded-lg overflow-hidden bg-gray-700 aspect-square';
                div.innerHTML = `
                    <img src="${e.target.result}" alt="${file.name}" class="w-full h-full object-cover">
                    ${index === 0 ? '<span class="absolute top-1 left-1 text-xs bg-green-500 text-white px-2 py-1 rounded">Principal</span>' : ''}
                    <button type="button" onclick="removeModalImage(${index})" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm hover:bg-red-600">
                        ×
                    </button>
                `;
                preview.appendChild(div);
            };
            reader.readAsDataURL(file);
        });

        // Re-configurar drag & drop para la nueva zona
        setTimeout(() => setupModalDragAndDrop(), 100);
    }

    // Eliminar imagen del modal
    function removeModalImage(index) {
        modalSelectedImages.splice(index, 1);
        updateModalImagePreview();
        updateModalImageInput();
        showModalNotification('🗑️ Imagen eliminada', 'info');
    }

    // Actualizar el input de imágenes del modal
    function updateModalImageInput() {
        const input = document.getElementById('modal_imagenes');
        if (!input) return;

        const dataTransfer = new DataTransfer();
        modalSelectedImages.forEach(file => dataTransfer.items.add(file));
        input.files = dataTransfer.files;
    }

    // Manejar selección de videos en el modal
    function handleModalVideoSelection(files) {
        const videoFiles = Array.from(files).filter(file => file.type.startsWith('video/'));

        const espacioDisponible = 5 - modalSelectedVideos.length;

        if (espacioDisponible === 0) {
            showModalNotification('⚠️ Ya has alcanzado el máximo de 5 videos', 'warning');
            return;
        }

        if (videoFiles.length > espacioDisponible) {
            showModalNotification(`⚠️ Solo puedes agregar ${espacioDisponible} video(s) más`, 'warning');
            videoFiles.splice(espacioDisponible);
        }

        // Validar tamaño de archivos (10MB max)
        const validFiles = videoFiles.filter(file => {
            const isDuplicate = modalSelectedVideos.some(existingFile =>
                existingFile.name === file.name &&
                existingFile.size === file.size
            );

            if (isDuplicate) {
                showModalNotification(`⚠️ ${file.name} ya fue agregado`, 'warning');
                return false;
            }

            if (file.size > 10 * 1024 * 1024) {
                showModalNotification(`❌ ${file.name} es demasiado grande (máx. 10MB)`, 'error');
                return false;
            }
            return true;
        });

        if (validFiles.length > 0) {
            modalSelectedVideos.push(...validFiles);
            showModalNotification(`✅ ${validFiles.length} video(s) agregado(s)`, 'success');
            updateModalVideoPreview();
        }
    }

    // Actualizar preview de videos en el modal
    function updateModalVideoPreview() {
        const preview = document.getElementById('modalVideoPreview');
        const counter = document.getElementById('modalVideoCounter');
        const count = document.getElementById('modalVideoCount');

        if (!preview || !counter || !count) return;

        if (modalSelectedVideos.length === 0) {
            preview.style.display = 'none';
            counter.style.display = 'none';
            return;
        }

        preview.style.display = 'grid';
        counter.style.display = 'block';
        count.textContent = modalSelectedVideos.length;

        preview.innerHTML = '';

        modalSelectedVideos.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const div = document.createElement('div');
                div.className = 'relative rounded-lg overflow-hidden bg-gray-700 aspect-square';
                div.innerHTML = `
                    <video src="${e.target.result}" class="w-full h-full object-cover"></video>
                    <button type="button" onclick="removeModalVideo(${index})" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm hover:bg-red-600">
                        ×
                    </button>
                `;
                preview.appendChild(div);
            };
            reader.readAsDataURL(file);
        });

        updateModalVideoInput();
    }

    // Eliminar video del modal
    function removeModalVideo(index) {
        modalSelectedVideos.splice(index, 1);
        updateModalVideoPreview();
        showModalNotification('🗑️ Video eliminado', 'info');
    }

    // Actualizar el input de videos del modal
    function updateModalVideoInput() {
        const input = document.getElementById('modal_videos');
        if (!input) return;

        const dataTransfer = new DataTransfer();
        modalSelectedVideos.forEach(file => dataTransfer.items.add(file));
        input.files = dataTransfer.files;
    }

    // ========== FUNCIONES PARA MÚLTIPLES IMÁGENES Y VIDEOS EN MODAL DE EDICIÓN ==========
    let editModalSelectedImages = [];
    let editModalSelectedVideos = [];
    let editImagenesToDelete = [];
    let editVideosToDelete = [];

    // Manejar selección de imágenes en el modal de edición
    function handleEditModalImageSelection(files) {
        const imageFiles = Array.from(files).filter(file => file.type.startsWith('image/'));

        // Verificar cuántas imágenes podemos agregar
        const espacioDisponible = 10 - editModalSelectedImages.length;

        if (espacioDisponible === 0) {
            showModalNotification('⚠️ Ya has alcanzado el máximo de 10 imágenes nuevas', 'warning');
            return;
        }

        if (imageFiles.length > espacioDisponible) {
            showModalNotification(`⚠️ Solo puedes agregar ${espacioDisponible} imagen(es) más`, 'warning');
            imageFiles.splice(espacioDisponible);
        }

        // Validar tamaño de archivos (5MB max)
        const validFiles = imageFiles.filter(file => {
            // Verificar que no sea un archivo duplicado
            const isDuplicate = editModalSelectedImages.some(existingFile =>
                existingFile.name === file.name &&
                existingFile.size === file.size &&
                existingFile.lastModified === file.lastModified
            );

            if (isDuplicate) {
                showModalNotification(`⚠️ ${file.name} ya fue agregada`, 'warning');
                return false;
            }

            if (file.size > 5 * 1024 * 1024) {
                showModalNotification(`❌ ${file.name} es demasiado grande (máx. 5MB)`, 'error');
                return false;
            }
            return true;
        });

        if (validFiles.length > 0) {
            editModalSelectedImages.push(...validFiles);
            showModalNotification(`✅ ${validFiles.length} imagen(es) agregada(s)`, 'success');
            updateEditModalImagePreview();
            updateEditModalImageInput();
        }
    }

    // Actualizar preview de imágenes nuevas en el modal de edición
    function updateEditModalImagePreview() {
        const preview = document.getElementById('editModalImagePreview');
        const counter = document.getElementById('editModalImageCounter');
        const count = document.getElementById('editModalImageCount');

        if (!preview || !counter || !count) return;

        if (editModalSelectedImages.length === 0) {
            preview.style.display = 'none';
            counter.style.display = 'none';
            return;
        }

        preview.style.display = 'grid';
        counter.style.display = 'block';
        count.textContent = editModalSelectedImages.length;

        preview.innerHTML = '';

        editModalSelectedImages.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const div = document.createElement('div');
                div.className = 'relative rounded-lg overflow-hidden bg-gray-700 aspect-square';
                div.innerHTML = `
                    <img src="${e.target.result}" alt="${file.name}" class="w-full h-full object-cover">
                    <span class="absolute top-1 left-1 text-xs bg-green-500 text-white px-2 py-1 rounded">Nueva</span>
                    <button type="button" onclick="removeEditModalImage(${index})" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm hover:bg-red-600">
                        ×
                    </button>
                `;
                preview.appendChild(div);
            };
            reader.readAsDataURL(file);
        });
    }

    // Eliminar imagen nueva del modal de edición
    function removeEditModalImage(index) {
        editModalSelectedImages.splice(index, 1);
        updateEditModalImagePreview();
        updateEditModalImageInput();
        showModalNotification('🗑️ Imagen eliminada', 'info');
    }

    // Actualizar el input de imágenes del modal de edición
    function updateEditModalImageInput() {
        const input = document.getElementById('edit_modal_imagenes');
        if (!input) return;

        const dataTransfer = new DataTransfer();
        editModalSelectedImages.forEach(file => dataTransfer.items.add(file));
        input.files = dataTransfer.files;
    }

    // Cargar imágenes existentes del animal en el modal de edición
    function loadExistingImages(imagenes) {
        const container = document.getElementById('editImagenesExistentes');
        const noMsg = document.getElementById('editNoImagenesMsg');

        if (!container) return;

        container.innerHTML = '';
        editImagenesToDelete = [];

        if (!imagenes || imagenes.length === 0) {
            noMsg.classList.remove('hidden');
            return;
        }

        noMsg.classList.add('hidden');

        imagenes.forEach(img => {
            const div = document.createElement('div');
            div.id = `edit-img-${img.id}`;
            div.className = 'relative rounded-lg overflow-hidden bg-gray-700 aspect-square';
            div.innerHTML = `
                <img src="${img.url}" alt="Imagen ${img.id}" class="w-full h-full object-cover">
                ${img.es_principal ? '<span class="absolute bottom-1 left-1 text-xs bg-green-500 text-white px-2 py-1 rounded">Principal</span>' : ''}
                <button type="button" onclick="toggleDeleteExistingImage(${img.id})" class="absolute top-1 right-1 bg-red-500/80 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm hover:bg-red-600 transition-all">
                    ×
                </button>
            `;
            container.appendChild(div);
        });
    }

    // Marcar/desmarcar imagen existente para eliminar
    function toggleDeleteExistingImage(imagenId) {
        const elemento = document.getElementById(`edit-img-${imagenId}`);
        const index = editImagenesToDelete.indexOf(imagenId);

        if (index > -1) {
            // Desmarcar
            editImagenesToDelete.splice(index, 1);
            elemento.classList.remove('opacity-40');
            elemento.querySelector('img').classList.remove('grayscale');
            const overlay = elemento.querySelector('.delete-overlay');
            if (overlay) overlay.remove();
            showModalNotification('↩️ Imagen restaurada', 'info');
        } else {
            // Marcar para eliminar
            editImagenesToDelete.push(imagenId);
            elemento.classList.add('opacity-40');
            elemento.querySelector('img').classList.add('grayscale');
            // Agregar overlay de eliminación
            const overlay = document.createElement('div');
            overlay.className = 'delete-overlay absolute inset-0 flex items-center justify-center bg-red-500/50';
            overlay.innerHTML = '<span class="text-white font-bold text-xs">ELIMINAR</span>';
            elemento.appendChild(overlay);
            showModalNotification('🗑️ Imagen marcada para eliminar', 'warning');
        }
    }

    // Manejar selección de videos en el modal de edición
    function handleEditModalVideoSelection(files) {
        const videoFiles = Array.from(files).filter(file => file.type.startsWith('video/'));

        const espacioDisponible = 5 - editModalSelectedVideos.length;

        if (espacioDisponible === 0) {
            showModalNotification('⚠️ Ya has alcanzado el máximo de 5 videos nuevos', 'warning');
            return;
        }

        if (videoFiles.length > espacioDisponible) {
            showModalNotification(`⚠️ Solo puedes agregar ${espacioDisponible} video(s) más`, 'warning');
            videoFiles.splice(espacioDisponible);
        }

        // Validar tamaño de archivos (10MB max)
        const validFiles = videoFiles.filter(file => {
            const isDuplicate = editModalSelectedVideos.some(existingFile =>
                existingFile.name === file.name &&
                existingFile.size === file.size
            );

            if (isDuplicate) {
                showModalNotification(`⚠️ ${file.name} ya fue agregado`, 'warning');
                return false;
            }

            if (file.size > 10 * 1024 * 1024) {
                showModalNotification(`❌ ${file.name} es demasiado grande (máx. 10MB)`, 'error');
                return false;
            }
            return true;
        });

        if (validFiles.length > 0) {
            editModalSelectedVideos.push(...validFiles);
            showModalNotification(`✅ ${validFiles.length} video(s) agregado(s)`, 'success');
            updateEditModalVideoPreview();
        }
    }

    // Actualizar preview de videos nuevos en el modal de edición
    function updateEditModalVideoPreview() {
        const preview = document.getElementById('editModalVideoPreview');
        const counter = document.getElementById('editModalVideoCounter');
        const count = document.getElementById('editModalVideoCount');

        if (!preview || !counter || !count) return;

        if (editModalSelectedVideos.length === 0) {
            preview.style.display = 'none';
            counter.style.display = 'none';
            return;
        }

        preview.style.display = 'grid';
        counter.style.display = 'block';
        count.textContent = editModalSelectedVideos.length;

        preview.innerHTML = '';

        editModalSelectedVideos.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const div = document.createElement('div');
                div.className = 'relative rounded-lg overflow-hidden bg-gray-700 aspect-square';
                div.innerHTML = `
                    <video src="${e.target.result}" class="w-full h-full object-cover"></video>
                    <span class="absolute top-1 left-1 text-xs bg-purple-500 text-white px-2 py-1 rounded">Nuevo</span>
                    <button type="button" onclick="removeEditModalVideo(${index})" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm hover:bg-red-600">
                        ×
                    </button>
                `;
                preview.appendChild(div);
            };
            reader.readAsDataURL(file);
        });

        updateEditModalVideoInput();
    }

    // Eliminar video nuevo del modal de edición
    function removeEditModalVideo(index) {
        editModalSelectedVideos.splice(index, 1);
        updateEditModalVideoPreview();
        showModalNotification('🗑️ Video eliminado', 'info');
    }

    // Actualizar el input de videos del modal de edición
    function updateEditModalVideoInput() {
        const input = document.getElementById('edit_modal_videos');
        if (!input) return;

        const dataTransfer = new DataTransfer();
        editModalSelectedVideos.forEach(file => dataTransfer.items.add(file));
        input.files = dataTransfer.files;
    }

    // Cargar videos existentes del animal en el modal de edición
    function loadExistingVideos(videos) {
        const container = document.getElementById('editVideosExistentes');
        const noMsg = document.getElementById('editNoVideosMsg');

        if (!container) return;

        container.innerHTML = '';
        editVideosToDelete = [];

        if (!videos || videos.length === 0) {
            noMsg.classList.remove('hidden');
            return;
        }

        noMsg.classList.add('hidden');

        videos.forEach(vid => {
            const div = document.createElement('div');
            div.id = `edit-vid-${vid.id}`;
            div.className = 'relative rounded-lg overflow-hidden bg-gray-700 aspect-video';
            div.innerHTML = `
                <video src="${vid.url}" class="w-full h-full object-cover" controls></video>
                <button type="button" onclick="toggleDeleteExistingVideo(${vid.id})" class="absolute top-1 right-1 bg-red-500/80 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm hover:bg-red-600 transition-all">
                    ×
                </button>
            `;
            container.appendChild(div);
        });
    }

    // Marcar/desmarcar video existente para eliminar
    function toggleDeleteExistingVideo(videoId) {
        const elemento = document.getElementById(`edit-vid-${videoId}`);
        const index = editVideosToDelete.indexOf(videoId);

        if (index > -1) {
            // Desmarcar
            editVideosToDelete.splice(index, 1);
            elemento.classList.remove('opacity-40');
            const overlay = elemento.querySelector('.delete-overlay');
            if (overlay) overlay.remove();
            showModalNotification('↩️ Video restaurado', 'info');
        } else {
            // Marcar para eliminar
            editVideosToDelete.push(videoId);
            elemento.classList.add('opacity-40');
            // Agregar overlay de eliminación
            const overlay = document.createElement('div');
            overlay.className = 'delete-overlay absolute inset-0 flex items-center justify-center bg-red-500/50 pointer-events-none';
            overlay.innerHTML = '<span class="text-white font-bold text-xs">ELIMINAR</span>';
            elemento.appendChild(overlay);
            showModalNotification('🗑️ Video marcado para eliminar', 'warning');
        }
    }

    // Resetear el modal de edición
    function resetEditModal() {
        editModalSelectedImages = [];
        editModalSelectedVideos = [];
        editImagenesToDelete = [];
        editVideosToDelete = [];

        const imgPreview = document.getElementById('editModalImagePreview');
        const vidPreview = document.getElementById('editModalVideoPreview');
        const imgCounter = document.getElementById('editModalImageCounter');
        const vidCounter = document.getElementById('editModalVideoCounter');

        if (imgPreview) imgPreview.style.display = 'none';
        if (vidPreview) vidPreview.style.display = 'none';
        if (imgCounter) imgCounter.style.display = 'none';
        if (vidCounter) vidCounter.style.display = 'none';

        // Limpiar inputs de archivo
        const imgInput = document.getElementById('edit_modal_imagenes');
        const vidInput = document.getElementById('edit_modal_videos');
        if (imgInput) imgInput.value = '';
        if (vidInput) vidInput.value = '';
    }

    // Configurar drag and drop para el modal de edición
    function setupEditModalDragAndDrop() {
        const dropZone = document.getElementById('editModalDropZone');
        if (!dropZone) return;

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaultsModal, false);
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
                dropZone.classList.add('border-blue-500', 'bg-blue-500/10');
            }, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
                dropZone.classList.remove('border-blue-500', 'bg-blue-500/10');
            }, false);
        });

        dropZone.addEventListener('drop', (e) => {
            handleEditModalImageSelection(e.dataTransfer.files);
        }, false);
    }

    // Función para mostrar notificaciones en el modal
    function showModalNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `fixed top-20 right-4 px-6 py-3 rounded-lg shadow-lg z-[60] transform transition-all duration-300 translate-x-full`;

        const colors = {
            'info': 'bg-blue-500',
            'success': 'bg-green-500',
            'warning': 'bg-yellow-500',
            'error': 'bg-red-500'
        };

        notification.classList.add(colors[type] || colors.info, 'text-white');
        notification.textContent = message;

        document.body.appendChild(notification);

        setTimeout(() => {
            notification.classList.remove('translate-x-full');
        }, 10);

        setTimeout(() => {
            notification.classList.add('translate-x-full');
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 300);
        }, 3000);
    }

    // Configurar drag and drop para el modal
    function setupModalDragAndDrop() {
        const dropZone = document.getElementById('modalDropZone');
        if (!dropZone) return;

        // Prevenir comportamiento por defecto
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.removeEventListener(eventName, preventDefaultsModal);
            dropZone.addEventListener(eventName, preventDefaultsModal, false);
        });

        // Highlight drop zone
        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.removeEventListener(eventName, highlightDropZone);
            dropZone.addEventListener(eventName, highlightDropZone, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.removeEventListener(eventName, unhighlightDropZone);
            dropZone.addEventListener(eventName, unhighlightDropZone, false);
        });

        // Manejar drop
        dropZone.removeEventListener('drop', handleModalDrop);
        dropZone.addEventListener('drop', handleModalDrop, false);
    }

    function preventDefaultsModal(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    function highlightDropZone() {
        const dropZone = document.getElementById('modalDropZone');
        if (dropZone) {
            dropZone.classList.add('border-blue-500', 'bg-blue-500', 'bg-opacity-10');
        }
    }

    function unhighlightDropZone() {
        const dropZone = document.getElementById('modalDropZone');
        if (dropZone) {
            dropZone.classList.remove('border-blue-500', 'bg-blue-500', 'bg-opacity-10');
        }
    }

    function handleModalDrop(e) {
        const files = e.dataTransfer.files;
        handleModalImageSelection(files);
    }

    // Inicializar drag and drop cuando el DOM esté listo
    document.addEventListener('DOMContentLoaded', function() {
        setupModalDragAndDrop();

        // Manejar el envío del formulario de edición para agregar IDs de elementos a eliminar
        const editForm = document.getElementById('editarAnimalFormElement');
        if (editForm) {
            editForm.addEventListener('submit', function(e) {
                // Agregar inputs hidden con los IDs de imágenes a eliminar
                editImagenesToDelete.forEach(id => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'eliminar_imagenes';
                    input.value = id;
                    this.appendChild(input);
                });

                // Agregar inputs hidden con los IDs de videos a eliminar
                editVideosToDelete.forEach(id => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'eliminar_videos';
                    input.value = id;
                    this.appendChild(input);
                });

                // Mostrar indicador de carga
                const overlay = document.getElementById('editarAnimalLoadingOverlay');
                if (overlay) overlay.classList.remove('hidden');
            });
        }
    });

    // Efecto parallax
    let ticking = false;
    window.addEventListener('scroll', () => {
        if (!ticking) {
            requestAnimationFrame(() => {
                const scrolled = window.pageYOffset;
                const stars = document.querySelectorAll('.star');

                stars.forEach((star, i) => {
                    if (i % 3 === 0) {
                        const speed = 0.5;
                        star.style.transform = `translateY(${scrolled * speed}px)`;
                    }
                });

                ticking = false;
            });
            ticking = true;
        }
    });
</script>

<!-- Token CSRF para peticiones AJAX -->
<form style="display: none;">
    {% csrf_token %}
</form>

</body>
</html>