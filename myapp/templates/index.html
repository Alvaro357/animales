{% load static %}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conectamos Corazones - Adopta un Animal | Perros, Gatos y más</title>

    <!-- SEO Meta Tags -->
    <meta name="description" content="Encuentra tu compañero perfecto para adoptar. Miles de perros, gatos y otros animales esperan un hogar. Conectamos asociaciones de animales con familias amorosas en toda España.">
    <meta name="keywords" content="adoptar animales, adopción perros, adopción gatos, protectoras de animales, asociaciones animales, mascotas en adopción, adoptar mascota España, refugio animales">
    <meta name="author" content="Conectamos Corazones">
    <meta name="robots" content="index, follow">
    <meta name="language" content="Spanish">
    <meta name="revisit-after" content="7 days">

    <!-- Canonical URL -->
    <link rel="canonical" href="{{ request.build_absolute_uri }}">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ request.build_absolute_uri }}">
    <meta property="og:title" content="Conectamos Corazones - Adopta un Animal">
    <meta property="og:description" content="Encuentra tu compañero perfecto para adoptar. Miles de animales esperan un hogar amoroso.">
    <meta property="og:image" content="{% static 'img/og-image.jpg' %}">
    <meta property="og:locale" content="es_ES">
    <meta property="og:site_name" content="Conectamos Corazones">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="{{ request.build_absolute_uri }}">
    <meta name="twitter:title" content="Conectamos Corazones - Adopta un Animal">
    <meta name="twitter:description" content="Encuentra tu compañero perfecto para adoptar. Miles de animales esperan un hogar amoroso.">
    <meta name="twitter:image" content="{% static 'img/og-image.jpg' %}">

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="{% static 'favicon.ico' %}">
    <link rel="apple-touch-icon" sizes="180x180" href="{% static 'apple-touch-icon.png' %}">

    <!-- Schema.org JSON-LD -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Organization",
        "name": "Conectamos Corazones",
        "description": "Plataforma de adopción de animales que conecta asociaciones protectoras con familias amorosas",
        "url": "{{ request.scheme }}://{{ request.get_host }}/",
        "logo": "{% static 'img/logo.png' %}",
        "sameAs": [],
        "contactPoint": {
            "@type": "ContactPoint",
            "contactType": "customer service",
            "availableLanguage": "Spanish"
        }
    }
    </script>

    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebSite",
        "name": "Conectamos Corazones",
        "url": "{{ request.scheme }}://{{ request.get_host }}/",
        "potentialAction": {
            "@type": "SearchAction",
            "target": "{{ request.scheme }}://{{ request.get_host }}/resultados-busqueda/?q={search_term_string}",
            "query-input": "required name=search_term_string"
        }
    }
    </script>

    <!-- Google AdSense Script - Reemplaza XXXXXXXXXXXXXXXX con tu ID de publicador -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-XXXXXXXXXXXXXXXX"
            crossorigin="anonymous"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style type="text/tailwindcss">
        html {
            font-size: 16px;
        }
        
        body {
            font-family: 'Pacifico', cursive;
            background: #0a0a0a;
            color: #ffe4cc;
            text-align: center;
            padding-top: 100px;
            position: relative;
            overflow-x: hidden;
            min-height: 100vh;
        }
        
        /* Fondo de estrellas interactivas */
        #starfield {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
        }
        
        .star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: #ffffff;
            border-radius: 50%;
            opacity: 0;
            animation: twinkle 3s infinite;
        }
        
        .star.large {
            width: 3px;
            height: 3px;
            animation: twinkle 4s infinite;
        }
        
        .star.bright {
            background: #ffd89b;
            box-shadow: 0 0 4px #ffd89b;
        }
        
        @keyframes twinkle {
            0%, 100% { opacity: 0; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.2); }
        }
        
        /* Efecto de movimiento de estrellas */
        .shooting-star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: linear-gradient(45deg, #ffd89b, transparent);
            border-radius: 50%;
            opacity: 0;
            animation: shoot 2s linear infinite;
        }
        
        @keyframes shoot {
            0% {
                opacity: 1;
                transform: translateX(-100px) translateY(100px);
            }
            100% {
                opacity: 0;
                transform: translateX(100px) translateY(-100px);
            }
        }
        
        /* Contenedor principal con z-index alto */
        .content-wrapper {
            position: relative;
            z-index: 10;
        }
        
        /* Navbar glassmorphism */
        .navbar-glass {
            backdrop-filter: blur(20px);
            background: rgba(10, 10, 10, 0.8);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Botones con efectos modernos */
        .btn-primary {
            background: linear-gradient(135deg, #ffb4a2, #ff9a7f);
            border: 1px solid rgba(255, 180, 162, 0.4);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            color: #5c4a42;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 40px rgba(255, 180, 162, 0.4);
        }
        
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn-primary:hover::before {
            left: 100%;
        }
        
        .btn-secondary {
            background: rgba(255, 201, 217, 0.15);
            border: 1px solid rgba(255, 201, 217, 0.3);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            color: #ffc9d9;
        }

        .btn-secondary:hover {
            background: rgba(255, 201, 217, 0.25);
            border-color: rgba(255, 201, 217, 0.5);
            transform: translateY(-1px);
        }
        
        /* Cards modernas */
        .animal-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }
        
        .animal-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 180, 162, 0.1), rgba(255, 201, 217, 0.1));
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 0;
        }
        
        .animal-card:hover::before {
            opacity: 1;
        }
        
        .animal-card:hover {
            transform: translateY(-8px);
            border-color: rgba(255, 180, 162, 0.4);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5),
                        0 0 0 1px rgba(255, 180, 162, 0.2);
        }
        
        .card-content {
            position: relative;
            z-index: 1;
        }

        /* Contenedor de anuncios */
        .ad-container {
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ad-wrapper {
            width: 100%;
            min-height: 90px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .ad-wrapper .adsbygoogle {
            width: 100%;
            min-height: 90px;
        }

        /* Responsive para anuncios */
        @media (max-width: 768px) {
            .ad-container {
                min-height: 80px;
            }
        }

        /* Botón de favorito */
        .favorite-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            z-index: 20;
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .favorite-btn:hover {
            background: rgba(0, 0, 0, 0.5);
            transform: scale(1.1);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        .favorite-btn.active {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.4);
        }
        
        .favorite-btn.active:hover {
            background: rgba(239, 68, 68, 0.3);
        }
        
        .heart-icon {
            width: 1.25rem;
            height: 1.25rem;
            transition: all 0.3s ease;
        }
        
        .heart-outline {
            stroke: #ffffff;
            stroke-width: 2;
            fill: none;
        }
        
        .favorite-btn:hover .heart-outline {
            stroke: #ffc9d9;
        }

        .heart-filled {
            fill: #ffc9d9;
            stroke: #ffc9d9;
            stroke-width: 1;
        }
        
        /* Animación de corazón */
        @keyframes heartBeat {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        .favorite-btn.animate-heart {
            animation: heartBeat 0.6s ease-in-out;
        }
        
        /* Filtros */
        .filter-container {
            background: rgba(10, 10, 10, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Estilos del buscador avanzado */
        .animal-selector {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .animal-card-selector {
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            min-width: 140px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .animal-card-selector::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.6s;
        }

        .animal-card-selector:hover::before {
            left: 100%;
        }

        .animal-card-selector:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
        }

        .animal-card-selector.active {
            background: rgba(255, 180, 162, 0.2);
            border-color: #ffb4a2;
            box-shadow: 0 0 30px rgba(255, 180, 162, 0.4);
            transform: translateY(-5px) scale(1.05);
        }

        .animal-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            display: block;
            transition: transform 0.3s ease;
        }

        .animal-card-selector:hover .animal-icon {
            transform: scale(1.2) rotate(5deg);
        }

        .animal-card-selector.active .animal-icon {
            animation: bounce 0.6s ease;
        }

        @keyframes bounce {
            0%, 20%, 53%, 80%, 100% { transform: scale(1.1); }
            40%, 43% { transform: scale(1.3); }
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .filter-group {
            position: relative;
        }

        .filter-label {
            display: block;
            color: #ffd4b8;
            font-weight: 500;
            font-size: 0.75rem;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: color 0.3s ease;
        }

        .filter-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #ffffff;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .filter-input:focus {
            outline: none;
            border-color: #ffb4a2;
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 0 3px rgba(255, 180, 162, 0.2);
        }

        .filter-input option {
            background-color: #1f2937;
            color: #ffffff;
            padding: 12px;
        }

        .otros-animales {
            display: none;
        }

        .otros-animales.show {
            display: block;
        }
        
        .filter-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #ffd4b8;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            min-height: 44px;
            font-size: 16px;
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #ffb4a2, #ff9a7f);
            border-color: #ffb4a2;
            color: #5c4a42;
            box-shadow: 0 0 20px rgba(255, 180, 162, 0.5);
        }

        .filter-btn:hover:not(.active) {
            background: rgba(255, 180, 162, 0.1);
            color: #ffe4cc;
        }
        
        /* Responsive para filtros */
        @media (max-width: 768px) {
            .filter-btn {
                padding: 24px 32px;
                font-size: 20px;
                min-width: 140px;
                min-height: 60px;
                font-weight: 600;
                border-width: 2px;
            }
            
            .filter-container {
                padding: 12px;
                margin: 0 -0.5rem;
            }
            
            .filter-container .flex {
                gap: 16px;
                flex-wrap: wrap;
            }
            
            .search-input {
                padding: 20px 24px;
                font-size: 18px;
                min-height: 60px;
            }
            
            .btn-primary, .btn-secondary {
                padding: 16px 24px;
                font-size: 18px;
                min-height: 54px;
            }
        }
        
        /* Buscador */
        .search-input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            color: #ffffff;
        }
        
        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        .search-input:focus {
            outline: none;
            border-color: #ffb4a2;
            box-shadow: 0 0 0 3px rgba(255, 180, 162, 0.2);
        }
        
        /* Título principal */
        .main-title {
            font-size: 3.5rem;
            font-weight: 700;
            line-height: 1.4;
            letter-spacing: -0.025em;
            background: linear-gradient(135deg, #ffe4cc, #ffb4a2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 2rem;
            padding: 0.5rem 0;
        }

        @media (max-width: 768px) {
            .main-title {
                font-size: 2.5rem;
                line-height: 1.3;
            }
            
            body {
                padding-top: 80px;
            }
            
            .filter-container {
                margin: 0 -1rem;
                border-radius: 1rem;
            }
            
            .animal-card {
                margin-bottom: 1rem;
            }
        }
        
        /* Contador de resultados */
        .results-counter {
            background: rgba(255, 216, 155, 0.15);
            border: 1px solid rgba(255, 216, 155, 0.3);
            color: #ffd89b;
        }

        .results-counter.no-results {
            background: rgba(255, 180, 162, 0.15);
            border: 1px solid rgba(255, 180, 162, 0.3);
            color: #ffb4a2;
        }
        
        /* Placeholders de carga */
        .loading-card {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
            animation: pulse 2s ease-in-out infinite alternate;
        }
        
        @keyframes pulse {
            0% { opacity: 0.4; }
            100% { opacity: 0.8; }
        }
        
        .loading-shimmer {
            background: linear-gradient(90deg,
                rgba(255, 255, 255, 0.05) 25%,
                rgba(255, 255, 255, 0.1) 50%,
                rgba(255, 255, 255, 0.05) 75%
            );
            background-size: 200% 100%;
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Lazy loading visual para imágenes */
        img[loading="lazy"] {
            opacity: 1;
        }

        img[loading="lazy"].loaded {
            opacity: 1;
        }

        /* Skeleton loader para el contenedor de imagen */
        .image-container {
            position: relative;
        }

        .image-container.image-loaded {
            background: transparent;
        }

        /* Modal moderno */
        .modal-backdrop {
            backdrop-filter: blur(10px);
            background: rgba(0, 0, 0, 0.8);
        }
        
        .modal-content {
            background: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Formularios */
        .form-input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #ffb4a2;
            box-shadow: 0 0 0 3px rgba(255, 180, 162, 0.2);
        }

        /* Estilos para campos con error */
        .form-input.border-red-500 {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
            background: rgba(239, 68, 68, 0.05);
        }

        .form-input.border-red-500:focus {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2) !important;
        }

        .form-label {
            color: #ffe4cc;
        }
        
        /* Estilos para select en modo oscuro */
        select.form-input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #ffffff;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }

        select.form-input option {
            background-color: #1f2937;
            color: #ffffff;
            padding: 8px 12px;
        }

        select.form-input option:checked,
        select.form-input option:hover {
            background-color: #ffb4a2;
            color: #5c4a42;
        }

        select.form-input:focus {
            outline: none;
            border-color: #ffb4a2;
            box-shadow: 0 0 0 3px rgba(255, 180, 162, 0.2);
        }
        
        /* Efectos de entrada */
        .fade-in {
            animation: fadeInUp 0.6s ease-out;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Scrollbar personalizada */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* Ocultar scrollbar horizontal */
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        
        /* Spinners para crear animal */
        .create-spinner {
            border: 3px solid rgba(255, 180, 162, 0.3);
            border-left: 3px solid #ffb4a2;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        .create-spinner-small {
            border: 2px solid rgba(255, 180, 162, 0.3);
            border-left: 2px solid #ffb4a2;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-dots::after {
            content: '';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }
        
        /* Estilos específicos para textarea */
        textarea.form-input {
            resize: vertical;
            min-height: 120px;
        }
        
        /* Indicadores de archivo */
        .file-indicator {
            background: rgba(255, 216, 155, 0.15);
            border: 1px solid rgba(255, 216, 155, 0.3);
            color: #ffd89b;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
        }

        /* Spinners de loading */
        .register-spinner {
            border: 3px solid rgba(255, 180, 162, 0.3);
            border-left: 3px solid #ffb4a2;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        .register-spinner-small {
            border: 2px solid rgba(255, 180, 162, 0.3);
            border-left: 2px solid #ffb4a2;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        
        /* Transiciones suaves entre formularios */
        .form-transition {
            transition: all 0.3s ease-in-out;
        }
        
        .form-fade-out {
            opacity: 0;
            transform: translateX(-20px);
        }
        
        .form-fade-in {
            opacity: 1;
            transform: translateX(0);
        }
        
        /* Contador de favoritos */
        .favorites-counter {
            background: rgba(255, 201, 217, 0.15);
            border: 1px solid rgba(255, 201, 217, 0.3);
            color: #ffc9d9;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 4px;
        }
    </style>
</head>
<body>

<!-- Fondo de estrellas -->
<div id="starfield"></div>

<!-- Wrapper de contenido -->
<div class="content-wrapper">

    <!-- Modal de Login/Registro -->
    <div id="authModal" class="fixed inset-0 flex items-center justify-center z-50 modal-backdrop hidden">
        <div id="modalContent" class="modal-content p-8 rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto transform scale-95 opacity-0 transition-all duration-500">
            <button onclick="cerrarModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl z-10">&times;</button>
            
            <!-- Formulario de Login -->
            <div id="loginForm">
                <h2 class="text-2xl font-semibold mb-6 text-center text-white">Iniciar sesión</h2>

                <!-- Mensaje de error de login -->
                <div id="loginErrorMessage" class="{% if not login_error %}hidden{% endif %} mb-4 p-4 rounded-lg border
                    {% if login_error.tipo == 'pendiente' %}bg-yellow-900/50 border-yellow-500{% endif %}
                    {% if login_error.tipo == 'rechazada' %}bg-red-900/50 border-red-500{% endif %}
                    {% if login_error.tipo == 'suspendida' %}bg-orange-900/50 border-orange-500{% endif %}
                    {% if login_error.tipo == 'eliminada' %}bg-red-900/50 border-red-500{% endif %}
                    {% if login_error.tipo == 'credenciales' %}bg-red-900/50 border-red-500{% endif %}
                    {% if login_error.tipo == 'desconocido' %}bg-gray-900/50 border-gray-500{% endif %}">
                    <div class="flex items-start">
                        {% if login_error.tipo == 'pendiente' %}
                        <svg class="w-5 h-5 text-yellow-400 mr-3 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                        </svg>
                        {% elif login_error.tipo == 'rechazada' or login_error.tipo == 'eliminada' or login_error.tipo == 'credenciales' %}
                        <svg class="w-5 h-5 text-red-400 mr-3 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                        </svg>
                        {% elif login_error.tipo == 'suspendida' %}
                        <svg class="w-5 h-5 text-orange-400 mr-3 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                        </svg>
                        {% else %}
                        <svg class="w-5 h-5 text-gray-400 mr-3 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        {% endif %}
                        <div class="flex-1">
                            <h4 class="font-semibold text-sm
                                {% if login_error.tipo == 'pendiente' %}text-yellow-300{% endif %}
                                {% if login_error.tipo == 'rechazada' or login_error.tipo == 'eliminada' or login_error.tipo == 'credenciales' %}text-red-300{% endif %}
                                {% if login_error.tipo == 'suspendida' %}text-orange-300{% endif %}
                                {% if login_error.tipo == 'desconocido' %}text-gray-300{% endif %}">
                                {{ login_error.mensaje }}
                            </h4>
                            <p class="text-xs mt-1
                                {% if login_error.tipo == 'pendiente' %}text-yellow-200/80{% endif %}
                                {% if login_error.tipo == 'rechazada' or login_error.tipo == 'eliminada' or login_error.tipo == 'credenciales' %}text-red-200/80{% endif %}
                                {% if login_error.tipo == 'suspendida' %}text-orange-200/80{% endif %}
                                {% if login_error.tipo == 'desconocido' %}text-gray-200/80{% endif %}">
                                {{ login_error.detalle }}
                            </p>
                        </div>
                        <button type="button" onclick="cerrarErrorLogin()" class="ml-2 text-gray-400 hover:text-white">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <form method="post" action="/login/">
                    {% csrf_token %}
                    <div class="mb-4">
                        <label for="username" class="block text-sm font-medium form-label mb-2">Usuario</label>
                        <input type="text" id="username" name="username" 
                               class="form-input w-full px-4 py-3 rounded-lg transition-all duration-300" required>
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-sm font-medium form-label mb-2">Contraseña</label>
                        <input type="password" id="password" name="password" 
                               class="form-input w-full px-4 py-3 rounded-lg transition-all duration-300" required>
                    </div>
                    <button type="submit" class="btn-primary w-full px-6 py-3 rounded-lg font-medium text-white">
                        Iniciar sesión
                    </button>

                    <div class="mt-4 text-center">
                        <a href="{% url 'solicitar_reset_password' %}" class="text-gray-400 hover:text-white text-sm transition-colors duration-300">
                            ¿Olvidaste tu contraseña?
                        </a>
                    </div>
                </form>

                <div class="mt-6 pt-6 border-t border-gray-700 text-center">
                    <p class="text-gray-400 text-sm mb-3">¿No tienes cuenta?</p>
                    <button onclick="mostrarRegistro()" class="btn-secondary inline-block px-6 py-2 rounded-lg text-sm font-medium text-white">
                        Regístrate
                    </button>
                </div>
            </div>

            <!-- Formulario de Registro -->
            <div id="registerForm" class="hidden">
                <h2 class="text-2xl font-semibold mb-6 text-center text-white">Registrar Asociación</h2>

                <!-- Mensaje de error -->
                <div id="registerErrorMessage" class="hidden mb-4 p-4 bg-red-900/50 border border-red-500 rounded-lg">
                    <div class="flex items-center">
                        <svg class="w-5 h-5 text-red-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                        </svg>
                        <span id="registerErrorText" class="text-red-300 text-sm"></span>
                    </div>
                </div>

                <!-- Mensaje de éxito -->
                <div id="registerSuccessMessage" class="hidden mb-4 p-4 bg-green-900/50 border border-green-500 rounded-lg">
                    <div class="flex items-center">
                        <svg class="w-5 h-5 text-green-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="text-green-300 text-sm">
                            <strong>¡Registro exitoso!</strong> Tu asociación ha sido registrada y está pendiente de aprobación. Recibirás un email con más información.
                        </span>
                    </div>
                </div>

                <!-- Overlay de loading para registro -->
                <div id="registerLoadingOverlay" class="absolute inset-0 flex items-center justify-center hidden bg-black/80 backdrop-blur-sm rounded-2xl">
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg flex flex-col items-center border border-gray-600">
                        <div class="register-spinner mb-3"></div>
                        <p class="text-white font-medium">Registrando asociación...</p>
                        <p class="text-sm text-gray-400 mt-1">Por favor, no cierres esta ventana</p>
                    </div>
                </div>

                <form method="post" action="/registro/" enctype="multipart/form-data" id="registerFormElement" onsubmit="return handleRegisterSubmit(event)">
                    {% csrf_token %}

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="reg_nombre" class="block text-sm font-medium form-label mb-2">
                                Nombre de la Asociación <span class="text-red-400">*</span>
                            </label>
                            <input type="text" id="reg_nombre" name="nombre"
                                   class="form-input w-full px-4 py-3 rounded-lg transition-all duration-300"
                                   required maxlength="50"
                                   placeholder="Ej: Protectora de Animales San Francisco">
                            <div id="nombre-error" class="hidden mt-1 text-sm text-red-400"></div>
                        </div>

                        <div>
                            <label for="reg_password" class="block text-sm font-medium form-label mb-2">
                                Contraseña <span class="text-red-400">*</span>
                            </label>
                            <input type="password" id="reg_password" name="password"
                                   class="form-input w-full px-4 py-3 rounded-lg transition-all duration-300"
                                   required minlength="6"
                                   placeholder="Mínimo 6 caracteres">
                            <div id="password-error" class="hidden mt-1 text-sm text-red-400"></div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="reg_email" class="block text-sm font-medium form-label mb-2">
                            Email <span class="text-red-400">*</span>
                        </label>
                        <input type="email" id="reg_email" name="email"
                               class="form-input w-full px-4 py-3 rounded-lg transition-all duration-300"
                               required
                               placeholder="contacto@tuasociacion.com">
                        <div id="email-error" class="hidden mt-1 text-sm text-red-400"></div>
                    </div>

                    <div class="mb-4">
                        <label for="reg_telefono" class="block text-sm font-medium form-label mb-2">
                            Teléfono <span class="text-red-400">*</span>
                        </label>
                        <input type="tel" id="reg_telefono" name="telefono"
                               class="form-input w-full px-4 py-3 rounded-lg transition-all duration-300"
                               required maxlength="15"
                               placeholder="+34 600 123 456">
                        <div id="telefono-error" class="hidden mt-1 text-sm text-red-400"></div>
                    </div>

                    <div class="mb-4">
                        <label for="reg_direccion" class="block text-sm font-medium form-label mb-2">
                            Dirección <span class="text-red-400">*</span>
                        </label>
                        <input type="text" id="reg_direccion" name="direccion"
                               class="form-input w-full px-4 py-3 rounded-lg transition-all duration-300"
                               required maxlength="200"
                               placeholder="Calle, número, piso...">
                        <div id="direccion-error" class="hidden mt-1 text-sm text-red-400"></div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div>
                            <label for="reg_poblacion" class="block text-sm font-medium form-label mb-2">
                                Población <span class="text-red-400">*</span>
                            </label>
                            <input type="text" id="reg_poblacion" name="poblacion"
                                   class="form-input w-full px-4 py-3 rounded-lg transition-all duration-300"
                                   required maxlength="50"
                                   placeholder="Ciudad o pueblo">
                            <div id="poblacion-error" class="hidden mt-1 text-sm text-red-400"></div>
                        </div>

                        <div>
                            <label for="reg_provincia" class="block text-sm font-medium form-label mb-2">
                                Provincia <span class="text-red-400">*</span>
                            </label>
                            <input type="text" id="reg_provincia" name="provincia"
                                   class="form-input w-full px-4 py-3 rounded-lg transition-all duration-300"
                                   required maxlength="50"
                                   placeholder="Ej: Barcelona, Madrid">
                            <div id="provincia-error" class="hidden mt-1 text-sm text-red-400"></div>
                        </div>

                        <div>
                            <label for="reg_codigo_postal" class="block text-sm font-medium form-label mb-2">
                                Código Postal <span class="text-red-400">*</span>
                            </label>
                            <input type="text" id="reg_codigo_postal" name="codigo_postal"
                                   class="form-input w-full px-4 py-3 rounded-lg transition-all duration-300"
                                   required maxlength="10"
                                   placeholder="08001"
                                   pattern="[0-9]{4,5}">
                            <div id="codigo_postal-error" class="hidden mt-1 text-sm text-red-400"></div>
                        </div>
                    </div>

                    <button type="submit" id="registerSubmitBtn" class="btn-primary w-full px-6 py-3 rounded-lg font-medium text-white mb-6">
                        <span class="button-text">Registrar Asociación</span>
                        <span class="button-loading hidden flex items-center justify-center">
                            <div class="register-spinner-small mr-2"></div>
                            <span class="loading-dots">Procesando</span>
                        </span>
                    </button>
                </form>
                
                <div class="pt-6 border-t border-gray-700 text-center">
                    <p class="text-gray-400 text-sm mb-3">¿Ya tienes cuenta?</p>
                    <button onclick="mostrarLogin()" class="btn-secondary inline-block px-6 py-2 rounded-lg text-sm font-medium text-white">
                        Iniciar sesión
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Crear Animal -->
    <div id="crearAnimalModal" class="fixed inset-0 flex items-center justify-center z-50 modal-backdrop hidden">
        <div id="crearAnimalContent" class="modal-content p-8 rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto transform scale-95 opacity-0 transition-all duration-500">
            <button onclick="cerrarCrearAnimal()" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl z-10">&times;</button>
            
            <div id="crearAnimalForm">
                <h2 class="text-3xl font-semibold mb-8 text-center text-white">Registrar Nuevo Animal</h2>

                <!-- Contenedor de errores del formulario -->
                <div id="formErrorsContainer" class="hidden mb-6 p-4 bg-red-900/50 border-2 border-red-400 rounded-lg">
                    <div class="flex items-start">
                        <svg class="w-6 h-6 text-red-400 mr-3 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                        </svg>
                        <div class="flex-1">
                            <h3 class="text-red-300 font-semibold mb-2">Error al crear el animal</h3>
                            <ul id="formErrorsList" class="list-disc list-inside text-red-200 text-sm space-y-1"></ul>
                        </div>
                        <button onclick="cerrarErrores()" class="text-red-400 hover:text-red-300 ml-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Overlay de loading -->
                <div id="crearAnimalLoadingOverlay" class="absolute inset-0 flex items-center justify-center hidden bg-black/80 backdrop-blur-sm rounded-2xl">
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg flex flex-col items-center border border-gray-600">
                        <div class="create-spinner mb-3"></div>
                        <p class="text-white font-medium">Creando animal...</p>
                        <p class="text-sm text-gray-400 mt-1">Por favor, no cierres esta ventana</p>
                    </div>
                </div>

                <form method="post" action="/crear_animal/" enctype="multipart/form-data" id="crearAnimalFormElement">
                    {% csrf_token %}
                    
                    <!-- Información básica -->
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold text-white mb-4 border-b border-gray-600 pb-2">Información Básica</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="animal_nombre" class="block text-sm font-medium form-label mb-2">
                                    Nombre <span class="text-red-400">*</span>
                                </label>
                                <input type="text" id="animal_nombre" name="nombre" 
                                       class="form-input w-full px-4 py-3 rounded-lg" required 
                                       placeholder="Nombre del animal">
                            </div>
                            
                            <div>
                                <label for="animal_tipo" class="block text-sm font-medium form-label mb-2">
                                    Tipo de Animal <span class="text-red-400">*</span>
                                </label>
                                <select id="animal_tipo" name="tipo_de_animal" 
                                        class="form-input w-full px-4 py-3 rounded-lg" required>
                                    <option value="" class="bg-gray-800">Seleccionar tipo</option>
                                    <option value="Perro" class="bg-gray-800">Perro</option>
                                    <option value="Gato" class="bg-gray-800">Gato</option>
                                    <option value="Conejo" class="bg-gray-800">Conejo</option>
                                    <option value="Pájaro" class="bg-gray-800">Pájaro</option>
                                    <option value="Otros" class="bg-gray-800">Otros</option>
                                </select>
                            </div>
                            
                            <!-- CAMPO COLOR COMBINADO -->
                            <div>
                                <label for="animal_color_select" class="block text-sm font-medium form-label mb-2">
                                    Color <span class="text-red-400">*</span>
                                </label>
                                <div class="space-y-3">
                                    <!-- Selector de colores predefinidos -->
                                    <select id="animal_color_select" name="color_predefinido" 
                                            class="form-input w-full px-4 py-3 rounded-lg" 
                                            onchange="manejarCambioColor()">
                                        <option value="" class="bg-gray-800">Seleccionar color</option>
                                        <option value="Negro" class="bg-gray-800">Negro</option>
                                        <option value="Blanco" class="bg-gray-800">Blanco</option>
                                        <option value="Marrón" class="bg-gray-800">Marrón</option>
                                        <option value="Gris" class="bg-gray-800">Gris</option>
                                        <option value="Dorado" class="bg-gray-800">Dorado</option>
                                        <option value="Rubio" class="bg-gray-800">Rubio</option>
                                        <option value="Rojizo" class="bg-gray-800">Rojizo</option>
                                        <option value="Atigrado" class="bg-gray-800">Atigrado</option>
                                        <option value="Manchado" class="bg-gray-800">Manchado</option>
                                        <option value="Tricolor" class="bg-gray-800">Tricolor</option>
                                        <option value="Bicolor" class="bg-gray-800">Bicolor</option>
                                        <option value="Otro" class="bg-gray-800">Otro (especificar)</option>
                                    </select>
                                    
                                    <!-- Campo de texto personalizado (oculto inicialmente) -->
                                    <input type="text" id="animal_color_custom" name="color_personalizado" 
                                    class="form-input w-full px-4 py-3 rounded-lg hidden" 
                                    placeholder="Especifica el color del animal..."
                                    oninput="actualizarColorPersonalizado()">
                                    
                                    <!-- Campo oculto que enviará el valor final -->
                                    <input type="hidden" id="animal_color_final" name="color" value="">
                                </div>
                            </div>
                            
                            <div>
                                <label for="animal_raza" class="block text-sm font-medium form-label mb-2">
                                    Raza <span class="text-red-400">*</span>
                                </label>
                                <input type="text" id="animal_raza" name="raza"
                                       class="form-input w-full px-4 py-3 rounded-lg" required
                                       placeholder="Raza del animal">
                            </div>

                            <div>
                                <label for="animal_tamano" class="block text-sm font-medium form-label mb-2">
                                    Tamaño <span class="text-red-400">*</span>
                                </label>
                                <select id="animal_tamano" name="tamano"
                                        class="form-input w-full px-4 py-3 rounded-lg" required>
                                    <option value="" class="bg-gray-800">Seleccionar tamaño</option>
                                    <option value="Mini" class="bg-gray-800">Mini</option>
                                    <option value="Pequeño" class="bg-gray-800">Pequeño</option>
                                    <option value="Mediano-Pequeño" class="bg-gray-800">Mediano-Pequeño</option>
                                    <option value="Mediano" class="bg-gray-800">Mediano</option>
                                    <option value="Mediano-Grande" class="bg-gray-800">Mediano-Grande</option>
                                    <option value="Grande" class="bg-gray-800">Grande</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Multimedia -->
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold text-white mb-4 border-b border-gray-600 pb-2">Multimedia</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium form-label mb-2">Imágenes</label>
                                <!-- Zona de drag and drop para múltiples imágenes -->
                                <label for="modal_imagenes" id="modalDropZone" class="file-upload-btn px-6 py-4 rounded-xl border-2 border-dashed border-gray-600 hover:border-blue-400 transition-all duration-300 group block" style="cursor: pointer;">
                                    <div class="flex flex-col items-center gap-3">
                                        <div class="w-12 h-12 bg-blue-500/20 rounded-xl flex items-center justify-center group-hover:bg-blue-500/30 transition-colors">
                                            <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                            </svg>
                                        </div>
                                        <div class="text-center">
                                            <p class="text-white font-medium">Subir Imágenes</p>
                                            <p class="text-gray-400 text-sm">Arrastra aquí o haz clic para seleccionar</p>
                                            <input type="file"
                                                   id="modal_imagenes"
                                                   name="imagenes"
                                                   accept="image/*"
                                                   multiple
                                                   class="hidden"
                                                   onchange="handleModalImageSelection(this.files)">
                                            <p class="text-xs text-gray-500 mt-2">Máximo 10 imágenes • JPG, PNG, GIF, WebP • Hasta 5MB</p>
                                        </div>
                                    </div>
                                </label>
                                <div id="modalImagePreview" class="grid grid-cols-3 gap-2 mt-3" style="display: none;"></div>
                                <p class="text-xs text-blue-400 mt-2 font-semibold" id="modalImageCounter" style="display: none;">
                                    <span id="modalImageCount">0</span> de 10 imágenes seleccionadas
                                </p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium form-label mb-2">Videos</label>
                                <div class="relative">
                                    <input type="file" id="modal_videos" name="videos" accept="video/*" multiple class="hidden" onchange="handleModalVideoSelection(this.files)">
                                    <label for="modal_videos" class="file-upload-btn w-full px-6 py-4 rounded-xl border-2 border-dashed border-gray-600 hover:border-purple-400 transition-all duration-300 group block cursor-pointer">
                                        <div class="flex flex-col items-center gap-3">
                                            <div class="w-12 h-12 bg-purple-500/20 rounded-xl flex items-center justify-center group-hover:bg-purple-500/30 transition-colors">
                                                <svg class="w-6 h-6 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                                </svg>
                                            </div>
                                            <div class="text-center">
                                                <p class="text-white font-medium">Subir Videos</p>
                                                <p class="text-gray-400 text-sm">Haz clic para seleccionar</p>
                                                <p class="text-xs text-gray-500 mt-1">Máximo 5 videos • MP4, AVI, MOV • Hasta 10MB</p>
                                            </div>
                                        </div>
                                    </label>
                                    <div id="modalVideoPreview" class="grid grid-cols-3 gap-2 mt-3" style="display: none;"></div>
                                    <p class="text-xs text-purple-400 mt-2 font-semibold" id="modalVideoCounter" style="display: none;">
                                        <span id="modalVideoCount">0</span> de 5 videos seleccionados
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Contacto -->
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold text-white mb-4 border-b border-gray-600 pb-2">Información de Contacto</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="animal_email" class="block text-sm font-medium form-label mb-2">
                                    Email <span class="text-red-400">*</span>
                                </label>
                                <input type="email" id="animal_email" name="email" 
                                       class="form-input w-full px-4 py-3 rounded-lg" required 
                                       placeholder="email@ejemplo.com">
                            </div>
                            
                            <div>
                                <label for="animal_telefono" class="block text-sm font-medium form-label mb-2">
                                    Teléfono <span class="text-red-400">*</span>
                                </label>
                                <input type="tel" id="animal_telefono" name="telefono" 
                                       class="form-input w-full px-4 py-3 rounded-lg" required 
                                       placeholder="123456789">
                            </div>
                        </div>
                    </div>

                    <!-- Ubicación -->
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold text-white mb-4 border-b border-gray-600 pb-2">Ubicación</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="animal_poblacion" class="block text-sm font-medium form-label mb-2">
                                    Población <span class="text-red-400">*</span>
                                </label>
                                <input type="text" id="animal_poblacion" name="poblacion" 
                                       class="form-input w-full px-4 py-3 rounded-lg" required 
                                       placeholder="Ciudad">
                            </div>
                            
                            <div>
                                <label for="animal_provincia" class="block text-sm font-medium form-label mb-2">
                                    Provincia <span class="text-red-400">*</span>
                                </label>
                                <input type="text" id="animal_provincia" name="provincia" 
                                       class="form-input w-full px-4 py-3 rounded-lg" required 
                                       placeholder="Provincia">
                            </div>
                            
                            <div>
                                <label for="animal_codigo_postal" class="block text-sm font-medium form-label mb-2">
                                    Código Postal <span class="text-red-400">*</span>
                                </label>
                                <input type="text" id="animal_codigo_postal" name="codigo_postal" 
                                       class="form-input w-full px-4 py-3 rounded-lg" required 
                                       placeholder="12345">
                            </div>
                        </div>
                    </div>

                    <!-- Descripción -->
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold text-white mb-4 border-b border-gray-600 pb-2">Descripción</h3>
                        <div>
                            <label for="animal_descripcion" class="block text-sm font-medium form-label mb-2">
                                Descripción <span class="text-red-400">*</span>
                            </label>
                            <textarea id="animal_descripcion" name="descripcion" rows="4"
                                      class="form-input w-full px-4 py-3 rounded-lg resize-none" required 
                                      placeholder="Cuéntanos sobre este animal especial..."></textarea>
                            <p class="text-gray-500 text-xs mt-1">Máximo 500 caracteres</p>
                        </div>
                    </div>

                    <button type="submit" id="crearAnimalSubmitBtn" class="btn-primary w-full px-6 py-4 rounded-lg font-semibold text-white text-lg">
                        <span class="button-text">Crear Animal</span>
                        <span class="button-loading hidden flex items-center justify-center">
                            <div class="create-spinner-small mr-2"></div>
                            <span class="loading-dots">Procesando</span>
                        </span>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Navbar -->
<nav class="navbar-glass fixed top-0 left-0 w-full flex items-center justify-between px-6 py-4 z-40">
    <div class="text-left">
        <h1 class="text-xl font-bold text-white">Conectamos Corazones</h1>
        {% if request.session.esta_logueado %}
            <p class="text-sm text-gray-400">Hola, {{ request.session.asociacion_nombre }}</p>
        {% endif %}
    </div>

    <div class="flex items-center gap-4">
        <a href="/mis-favoritos/" class="btn-secondary px-4 py-2 rounded-lg text-sm font-medium text-white flex items-center">
            <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 24 24">
                <path d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
            </svg>
            Favoritos
            <span id="favoritesCounter" class="favorites-counter hidden">0</span>
        </a>
        
        {% if request.session.esta_logueado %}
            <a href="/mis_animales/" class="btn-secondary px-4 py-2 rounded-lg text-sm font-medium text-white">
                Mis Animales
            </a>
            <button onclick="abrirCrearAnimal()" class="btn-primary px-4 py-2 rounded-lg text-sm font-medium text-white">
                Crear Animal
            </button>
            <a href="/logout/" class="text-red-400 hover:text-red-300 px-4 py-2 border border-red-400/30 hover:border-red-300 rounded-lg text-sm transition-all duration-300">
                Salir
            </a>
        {% else %}
            <button onclick="abrirLogin()" class="btn-primary px-6 py-2 rounded-lg text-sm font-medium text-white">
                Iniciar sesión
            </button>
        {% endif %}
    </div>
</nav>

    <!-- Mensajes de Django -->
    {% if messages %}
    <div class="fixed top-24 left-1/2 transform -translate-x-1/2 z-50 w-full max-w-3xl px-4">
        {% for message in messages %}
        <div class="message-card mb-4 relative overflow-hidden rounded-2xl shadow-2xl backdrop-blur-xl animate-slide-down {% if message.tags == 'error' %}bg-gradient-to-r from-red-900/95 to-red-800/95 border-2 border-red-400/50{% elif message.tags == 'success' %}bg-gradient-to-r from-green-900/95 to-green-800/95 border-2 border-green-400/50{% elif message.tags == 'warning' %}bg-gradient-to-r from-yellow-900/95 to-yellow-800/95 border-2 border-yellow-400/50{% else %}bg-gradient-to-r from-blue-900/95 via-blue-800/95 to-purple-900/95 border-2 border-blue-400/50{% endif %}">

            <!-- Efecto de brillo animado -->
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r {% if message.tags == 'error' %}from-red-400 via-red-300 to-red-400{% elif message.tags == 'success' %}from-green-400 via-green-300 to-green-400{% elif message.tags == 'warning' %}from-yellow-400 via-yellow-300 to-yellow-400{% else %}from-blue-400 via-purple-400 to-blue-400{% endif %} animate-shimmer"></div>

            <!-- Patrón de fondo sutil -->
            <div class="absolute inset-0 opacity-10" style="background-image: radial-gradient(circle at 20% 50%, white 1px, transparent 1px); background-size: 30px 30px;"></div>

            <div class="relative p-6">
                <div class="flex items-start">
                    <!-- Icono grande y destacado -->
                    <div class="flex-shrink-0 mr-4">
                        <div class="w-12 h-12 rounded-full flex items-center justify-center {% if message.tags == 'error' %}bg-red-500/30 border-2 border-red-400{% elif message.tags == 'success' %}bg-green-500/30 border-2 border-green-400{% elif message.tags == 'warning' %}bg-yellow-500/30 border-2 border-yellow-400{% else %}bg-blue-500/30 border-2 border-blue-400{% endif %} animate-pulse-slow">
                            <svg class="w-7 h-7 {% if message.tags == 'error' %}text-red-300{% elif message.tags == 'success' %}text-green-300{% elif message.tags == 'warning' %}text-yellow-300{% else %}text-blue-300{% endif %}" fill="currentColor" viewBox="0 0 20 20">
                                {% if message.tags == 'error' %}
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                {% elif message.tags == 'success' %}
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                {% else %}
                                <path d="M10 2C5 2 2 5.5 2 9.5c0 3.78 2.38 6.5 6 8.5L10 20l2-2c3.62-2 6-4.72 6-8.5C18 5.5 15 2 10 2zm0 14.5l-1.5-1.5C5.5 13 4 11 4 9.5 4 6.5 6.5 4 10 4s6 2.5 6 5.5c0 1.5-1.5 3.5-4.5 5.5L10 16.5z"/>
                                {% endif %}
                            </svg>
                        </div>
                    </div>

                    <!-- Contenido del mensaje -->
                    <div class="flex-1 pt-1">
                        <h3 class="text-base font-semibold mb-2 {% if message.tags == 'error' %}text-red-100{% elif message.tags == 'success' %}text-green-100{% elif message.tags == 'warning' %}text-yellow-100{% else %}text-blue-100{% endif %}">
                            {% if message.tags == 'error' %}
                            Error
                            {% elif message.tags == 'success' %}
                            Éxito
                            {% elif message.tags == 'warning' %}
                            Aviso
                            {% else %}
                            Bienvenido
                            {% endif %}
                        </h3>
                        <p class="text-sm leading-relaxed text-white/90 font-medium">{{ message }}</p>
                    </div>

                    <!-- Botón de cerrar mejorado -->
                    <button onclick="cerrarMensaje(this)" class="ml-4 flex-shrink-0 w-8 h-8 rounded-full hover:bg-white/20 transition-all duration-300 flex items-center justify-center group">
                        <svg class="w-5 h-5 text-white/70 group-hover:text-white group-hover:rotate-90 transition-all duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Barra de progreso para cierre automático -->
            <div class="absolute bottom-0 left-0 h-1 bg-white/30 progress-bar" style="animation: progress 8s linear forwards;"></div>
        </div>
        {% endfor %}
    </div>

    <style>
        @keyframes slide-down {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes shimmer {
            0%, 100% {
                opacity: 0.5;
            }
            50% {
                opacity: 1;
            }
        }

        @keyframes progress {
            from {
                width: 100%;
            }
            to {
                width: 0%;
            }
        }

        @keyframes pulse-slow {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.8;
                transform: scale(1.05);
            }
        }

        .animate-slide-down {
            animation: slide-down 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .animate-shimmer {
            animation: shimmer 2s ease-in-out infinite;
        }

        .animate-pulse-slow {
            animation: pulse-slow 2s ease-in-out infinite;
        }

        .message-card {
            box-shadow:
                0 10px 30px rgba(0, 0, 0, 0.5),
                0 0 40px rgba(59, 130, 246, 0.2);
        }

        .progress-bar {
            transform-origin: left;
        }
    </style>

    <script>
        function cerrarMensaje(btn) {
            const messageCard = btn.closest('.message-card');
            messageCard.style.animation = 'slide-up 0.4s ease-out forwards';
            setTimeout(() => messageCard.remove(), 400);
        }

        // Auto-cerrar mensajes después de 8 segundos
        document.addEventListener('DOMContentLoaded', function() {
            const messages = document.querySelectorAll('.message-card');
            messages.forEach(msg => {
                setTimeout(() => {
                    if (msg.parentElement) {
                        msg.style.animation = 'slide-up 0.4s ease-out forwards';
                        setTimeout(() => msg.remove(), 400);
                    }
                }, 8000);
            });
        });

        const style = document.createElement('style');
        style.textContent = `
            @keyframes slide-up {
                to {
                    opacity: 0;
                    transform: translateY(-30px) scale(0.95);
                }
            }
        `;
        document.head.appendChild(style);
    </script>
    {% endif %}

    <!-- Contenido principal -->
    <div class="max-w-7xl mx-auto px-6 py-20">
        
        <!-- Título y descripción principal -->
        <div class="text-center mb-16 fade-in">
            <h1 class="main-title">
                Encuentra tu compañero perfecto
            </h1>
            <p class="text-xl text-gray-400 max-w-2xl mx-auto leading-relaxed">
                Conectamos corazones. Cada animal merece una segunda oportunidad y un hogar lleno de amor.
            </p>
        </div>

        <!-- Filtros y buscador -->
        <div class="mb-12 fade-in">
            <!-- Filtros -->
            <div class="filter-container rounded-2xl p-6 mb-8">
                <!-- Selector de tipo de animal -->
                <div class="animal-selector">
                    <div class="animal-card-selector active" onclick="selectAnimalIndex('todos')" id="card-todos">
                        <span class="animal-icon">🐾</span>
                        <span class="font-semibold">Todos</span>
                    </div>
                    <div class="animal-card-selector" onclick="selectAnimalIndex('perro')" id="card-perro">
                        <span class="animal-icon">🐕</span>
                        <span class="font-semibold">Perros</span>
                    </div>
                    <div class="animal-card-selector" onclick="selectAnimalIndex('gato')" id="card-gato">
                        <span class="animal-icon">🐱</span>
                        <span class="font-semibold">Gatos</span>
                    </div>
                    <div class="animal-card-selector" onclick="selectAnimalIndex('otros')" id="card-otros">
                        <span class="animal-icon">🐦</span>
                        <span class="font-semibold">Otros</span>
                    </div>
                </div>

                <!-- Filtros -->
                <div class="filters-grid">
                    <div class="filter-group">
                        <label class="filter-label">Ubicación</label>
                        <select id="ubicacion-select" class="filter-input">
                            <option value="">Todas las ubicaciones</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label" id="raza-label">Raza</label>
                        <select id="raza-select" class="filter-input">
                            <option value="">Cualquier raza</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Color</label>
                        <select id="color-select" class="filter-input">
                            <option value="">Cualquier color</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Tamaño</label>
                        <select id="tamano-select" class="filter-input">
                            <option value="">Cualquier tamaño</option>
                        </select>
                    </div>

                    <!-- Campo especial para otros animales -->
                    <div class="otros-animales show" id="otros-animales-field">
                        <div class="filter-group">
                            <label class="filter-label">Tipo de Animal</label>
                            <select id="otros-animales-select" class="filter-input">
                                <option value="">Selecciona un tipo</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contador de resultados -->
            <div class="text-center mb-8">
                <span id="contadorResultados" class="results-counter inline-block px-4 py-2 rounded-full text-sm font-medium"></span>
            </div>
        </div>

        <!-- Grid de animales -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8" id="contenedorAnimales">
            <!-- Las tarjetas se generan dinámicamente -->
        </div>
    </div>

</div>

<!-- JavaScript -->
<script>
    // Datos de animales
    let animalesData = [
        {% for animal in animales %}
        {
            id: {{ animal.id }},
            nombre: "{{ animal.nombre|escapejs }}",
            tipo: "{{ animal.tipo_de_animal|escapejs }}",
            raza: "{{ animal.raza|escapejs }}",
            color: "{{ animal.color|escapejs }}",
            tamano: "{{ animal.tamano|escapejs }}",
            email: "{{ animal.email|escapejs }}",
            telefono: "{{ animal.telefono|escapejs }}",
            poblacion: "{{ animal.poblacion|escapejs }}",
            provincia: "{{ animal.provincia|escapejs }}",
            descripcion: "{{ animal.descripcion|escapejs }}",
            imagen: "{% if animal.get_primera_imagen %}{{ animal.get_primera_imagen }}{% endif %}"
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    // Cargar favoritos con error handling
    let favoritos = [];
    try {
        favoritos = JSON.parse(localStorage.getItem('favoritos')) || [];
    } catch (e) {
        console.error('Error al cargar favoritos desde localStorage:', e);
        favoritos = [];
    }

    // Variables para carga por lotes
    let animalesFiltrados = [];
    let animalesMostrados = 0;
    const ANIMALES_POR_LOTE = 12; // Número de animales a cargar por vez
    let cargando = false;

    // Configuración de anuncios
    const ANIMALES_ENTRE_ANUNCIOS = 6; // Mostrar anuncio cada 6 animales
    let anunciosMostrados = 0;

    // Función para manejar cambios en el selector de color
// Versión corregida sin event listeners duplicados
function manejarCambioColor() {
    const colorSelect = document.getElementById('animal_color_select');
    const colorCustom = document.getElementById('animal_color_custom');
    const colorFinal = document.getElementById('animal_color_final');
    
    if (colorSelect.value === 'Otro') {
        colorCustom.classList.remove('hidden');
        colorCustom.setAttribute('required', 'required');
        colorCustom.focus();
        colorFinal.value = '';
    } else if (colorSelect.value === '') {
        colorCustom.classList.add('hidden');
        colorCustom.removeAttribute('required');
        colorCustom.value = '';
        colorFinal.value = '';
    } else {
        colorCustom.classList.add('hidden');
        colorCustom.removeAttribute('required');
        colorCustom.value = '';
        colorFinal.value = colorSelect.value; // Esto asigna el color inmediatamente
    }
}

// Función separada para el input personalizado
function actualizarColorPersonalizado() {
    const colorCustom = document.getElementById('animal_color_custom');
    const colorFinal = document.getElementById('animal_color_final');
    
    if (colorCustom && colorFinal) {
        colorFinal.value = colorCustom.value.trim();
    }
}
    // Función para resetear el selector de color
    function resetColorSelector() {
        const colorSelect = document.getElementById('animal_color_select');
        const colorCustom = document.getElementById('animal_color_custom');
        const colorFinal = document.getElementById('animal_color_final');
        
        if (colorSelect) colorSelect.value = '';
        if (colorCustom) {
            colorCustom.classList.add('hidden');
            colorCustom.removeAttribute('required');
            colorCustom.value = '';
        }
        if (colorFinal) colorFinal.value = '';
    }

    // Validación del formulario antes del envío
    function validarColorAntesDelEnvio() {
        const colorSelect = document.getElementById('animal_color_select');
        const colorCustom = document.getElementById('animal_color_custom');
        const colorFinal = document.getElementById('animal_color_final');
        
        if (colorSelect.value === '') {
            alert('Por favor, selecciona un color para el animal.');
            colorSelect.focus();
            return false;
        }
        
        if (colorSelect.value === 'Otro' && (!colorCustom.value || colorCustom.value.trim() === '')) {
            alert('Por favor, especifica el color del animal.');
            colorCustom.focus();
            return false;
        }
        
        if (!colorFinal.value || colorFinal.value.trim() === '') {
            manejarCambioColor();
            if (!colorFinal.value || colorFinal.value.trim() === '') {
                alert('Error al procesar el color. Por favor, intenta de nuevo.');
                return false;
            }
        }
        
        return true;
    }

    // Crear fondo de estrellas
    function crearEstrellas() {
        const starfield = document.getElementById('starfield');
        const numStars = 150;
        
        for (let i = 0; i < numStars; i++) {
            const star = document.createElement('div');
            star.className = 'star';
            
            if (Math.random() < 0.1) star.classList.add('large');
            if (Math.random() < 0.05) star.classList.add('bright');
            
            star.style.left = Math.random() * 100 + '%';
            star.style.top = Math.random() * 100 + '%';
            star.style.animationDelay = Math.random() * 3 + 's';
            
            starfield.appendChild(star);
        }
        
        setInterval(() => {
            if (Math.random() < 0.3) {
                const shootingStar = document.createElement('div');
                shootingStar.className = 'shooting-star';
                shootingStar.style.left = Math.random() * 100 + '%';
                shootingStar.style.top = Math.random() * 100 + '%';
                
                starfield.appendChild(shootingStar);
                
                setTimeout(() => {
                    if (shootingStar.parentNode) {
                        shootingStar.remove();
                    }
                }, 2000);
            }
        }, 3000);
    }

    // Crear placeholder de carga
    function crearPlaceholder(index) {
        return `
            <div class="loading-card rounded-2xl p-6 h-auto" data-index="${index}">
                <div class="loading-shimmer aspect-[3/4] rounded-xl mb-4"></div>
                <div class="loading-shimmer rounded h-6 mb-2"></div>
                <div class="loading-shimmer rounded h-4 w-3/4 mb-2"></div>
                <div class="loading-shimmer rounded h-4 w-1/2"></div>
            </div>
        `;
    }

    // Crear tarjeta de animal
    function crearTarjetaAnimal(animal) {
        const esFavorito = favoritos.includes(animal.id);

        return `
            <div class="animal-card rounded-2xl overflow-hidden fade-in"
                 data-nombre="${animal.nombre.toLowerCase()}"
                 data-tipo="${animal.tipo.toLowerCase()}"
                 data-raza="${animal.raza.toLowerCase()}"
                 data-provincia="${animal.provincia.toLowerCase()}"
                 data-color="${animal.color ? animal.color.toLowerCase() : ''}"
                 data-tamano="${animal.tamano || ''}"
                 data-id="${animal.id}">
                
                <!-- Botón de favorito -->
                <button onclick="toggleFavorito(${animal.id}, this, event)" 
                        class="favorite-btn ${esFavorito ? 'active' : ''}" 
                        data-favorito="${esFavorito}">
                    ${esFavorito ? `
                        <svg class="heart-icon heart-filled" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                        </svg>
                    ` : `
                        <svg class="heart-icon heart-outline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                        </svg>
                    `}
                </button>
                
                <a href="/ver_animal/${animal.id}/" class="block">
                    <div class="card-content">
                        <div class="aspect-square bg-gray-800 rounded-t-2xl overflow-hidden relative image-container">
                            ${animal.imagen ? `
                                <img src="${animal.imagen}"
                                     alt="${animal.nombre}"
                                     class="w-full h-full object-cover object-center transition-transform duration-500 hover:scale-110"
                                     loading="lazy"
                                     decoding="async">
                            ` : `
                                <div class="w-full h-full flex items-center justify-center text-gray-500">
                                    <svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                </div>
                            `}
                        </div>

                        <div class="p-6 text-center">
                            <h3 class="text-2xl font-bold text-white mb-1 tracking-wide">${animal.nombre}</h3>
                            <p class="text-blue-300 font-medium text-sm uppercase tracking-wider mb-1 opacity-90">${animal.raza}</p>
                            <p class="text-gray-400 text-xs uppercase tracking-wide mb-3 opacity-75">Tamaño: ${animal.tamano}</p>

                            <div class="flex items-center justify-center text-gray-400 text-sm">
                                <svg class="w-4 h-4 mr-1.5 opacity-60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                                <span class="font-medium">${animal.poblacion}, ${animal.provincia}</span>
                            </div>
                        </div>
                    </div>
                </a>
            </div>
        `;
    }

    // Toggle favorito
    function toggleFavorito(animalId, button, event) {
        event.preventDefault();
        event.stopPropagation();
        
        const esFavorito = favoritos.includes(animalId);
        
        if (esFavorito) {
            // Quitar de favoritos
            favoritos = favoritos.filter(id => id !== animalId);
            button.classList.remove('active');
            button.innerHTML = `
                <svg class="heart-icon heart-outline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                </svg>
            `;
        } else {
            // Agregar a favoritos
            favoritos.push(animalId);
            button.classList.add('active');
            button.innerHTML = `
                <svg class="heart-icon heart-filled" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                </svg>
            `;
            
            // Animación
            button.classList.add('animate-heart');
            setTimeout(() => button.classList.remove('animate-heart'), 600);
        }
        
        // Guardar en localStorage
        localStorage.setItem('favoritos', JSON.stringify(favoritos));
        
        // Actualizar contador
        actualizarContadorFavoritos();
    }

    // Actualizar contador de favoritos
    function actualizarContadorFavoritos() {
        const counter = document.getElementById('favoritesCounter');
        if (!counter) return;

        if (favoritos.length > 0) {
            counter.textContent = favoritos.length;
            counter.classList.remove('hidden');
        } else {
            counter.classList.add('hidden');
        }
    }

    // El lazy loading se maneja con el atributo loading="lazy" nativo del navegador

    // Detectar scroll para cargar más - crear sentinela ANTES de usarla
    const sentinela = document.createElement('div');
    sentinela.id = 'scroll-sentinela';
    sentinela.style.height = '1px';

    const scrollObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting && !cargando) {
                cargarSiguienteLote();
            }
        });
    }, { rootMargin: '500px' });

    // Crear bloque de anuncio de Google AdSense
    function crearAnuncio() {
        anunciosMostrados++;
        return `
            <div class="ad-container rounded-2xl overflow-hidden col-span-1 md:col-span-2 lg:col-span-3 my-4"
                 data-ad="true">
                <div class="ad-wrapper bg-gradient-to-r from-gray-900/50 to-gray-800/50 backdrop-blur-sm border border-white/10 rounded-2xl p-4">
                    <p class="text-xs text-gray-500 mb-2 text-center uppercase tracking-wider">Publicidad</p>
                    <!-- Google AdSense - Reemplaza con tu código real -->
                    <ins class="adsbygoogle"
                         style="display:block"
                         data-ad-client="ca-pub-XXXXXXXXXXXXXXXX"
                         data-ad-slot="XXXXXXXXXX"
                         data-ad-format="auto"
                         data-full-width-responsive="true"></ins>
                    <script>
                         (adsbygoogle = window.adsbygoogle || []).push({});
                    </script>
                </div>
            </div>
        `;
    }

    // Cargar siguiente lote de animales
    function cargarSiguienteLote() {
        if (cargando || animalesMostrados >= animalesFiltrados.length) {
            return;
        }

        cargando = true;
        const contenedor = document.getElementById('contenedorAnimales');

        const fin = Math.min(animalesMostrados + ANIMALES_POR_LOTE, animalesFiltrados.length);

        for (let i = animalesMostrados; i < fin; i++) {
            const animal = animalesFiltrados[i];
            const tarjeta = document.createElement('div');
            tarjeta.innerHTML = crearTarjetaAnimal(animal);
            contenedor.appendChild(tarjeta.firstElementChild);

            // Insertar anuncio cada ANIMALES_ENTRE_ANUNCIOS animales
            const posicionGlobal = i + 1; // Posición real (1-indexed)
            if (posicionGlobal > 0 && posicionGlobal % ANIMALES_ENTRE_ANUNCIOS === 0) {
                const anuncioDiv = document.createElement('div');
                anuncioDiv.innerHTML = crearAnuncio();
                contenedor.appendChild(anuncioDiv.firstElementChild);
            }
        }

        animalesMostrados = fin;
        cargando = false;

        // Actualizar contador
        actualizarContador(animalesFiltrados.length);

        // Mover el sentinela al final (reutilizando variable contenedor)
        if (sentinela.parentNode) {
            contenedor.appendChild(sentinela);
        }
    }

    // Inicializar animales con filtros
    function inicializarAnimales() {
        const contenedor = document.getElementById('contenedorAnimales');
        contenedor.innerHTML = '';

        // Reiniciar contadores
        animalesMostrados = 0;
        anunciosMostrados = 0;
        animalesFiltrados = animalesData;

        // Cargar primer lote
        cargarSiguienteLote();

        // Agregar sentinela al final para detectar scroll
        contenedor.appendChild(sentinela);
        scrollObserver.observe(sentinela);
    }

    // Normalizar texto para búsqueda
    function normalizarTexto(texto) {
        return texto.toLowerCase()
                   .normalize('NFD')
                   .replace(/[\u0300-\u036f]/g, '')
                   .trim();
    }

    // Funciones obsoletas eliminadas - filtrarPorTipo y aplicarFiltros
    // Ahora se usa selectAnimalIndex() y aplicarFiltrosAvanzados()

    // Actualizar contador
    function actualizarContador(cantidad) {
        const contador = document.getElementById('contadorResultados');
        if (!contador) return;

        if (cantidad === 0) {
            contador.textContent = 'No se encontraron animales';
            contador.className = 'results-counter no-results inline-block px-4 py-2 rounded-full text-sm font-medium';
        } else {
            contador.textContent = `${cantidad} animal${cantidad !== 1 ? 'es' : ''} disponible${cantidad !== 1 ? 's' : ''}`;
            contador.className = 'results-counter inline-block px-4 py-2 rounded-full text-sm font-medium';
        }
    }

    // ================ BUSCADOR AVANZADO ================

    // Variables para el buscador avanzado
    let filtrosAvanzados = {
        categoria: 'todos',
        provincia: '',
        raza: '',
        color: '',
        tamano: '',
        tipo_animal: ''
    };

    // Selección de tipo de animal (con iconos)
    function selectAnimalIndex(tipo) {
        document.querySelectorAll('.animal-card-selector').forEach(card => {
            card.classList.remove('active');
        });

        const targetCard = document.getElementById(`card-${tipo}`);
        if (targetCard) {
            targetCard.classList.add('active');
        }

        filtrosAvanzados.categoria = tipo;
        filtrosAvanzados.provincia = '';
        filtrosAvanzados.raza = '';
        filtrosAvanzados.color = '';
        filtrosAvanzados.tamano = '';
        filtrosAvanzados.tipo_animal = '';

        const razaLabel = document.getElementById('raza-label');
        const otrosField = document.getElementById('otros-animales-field');

        if (razaLabel) {
            if (tipo === 'todos') {
                razaLabel.textContent = 'Raza';
            } else if (tipo === 'otros') {
                razaLabel.textContent = 'VARIEDAD';
            } else {
                razaLabel.textContent = 'RAZA';
            }
        }

        if (otrosField) {
            if (tipo === 'otros') {
                otrosField.classList.add('show');
            } else {
                otrosField.classList.remove('show');
            }
        }

        actualizarSelectoresAvanzados('');
        aplicarFiltrosAvanzados();
    }

    // Filtrar animales según filtros avanzados
    function filtrarAnimalesAvanzado() {
        return animalesData.filter(animal => {
            const tipo = animal.tipo.toLowerCase();

            // Filtro de categoría
            let cumpleCategoria = true;
            if (filtrosAvanzados.categoria && filtrosAvanzados.categoria !== 'todos') {
                if (filtrosAvanzados.categoria === 'otros') {
                    cumpleCategoria = !tipo.includes('perro') && !tipo.includes('gato');
                } else {
                    cumpleCategoria = tipo.includes(filtrosAvanzados.categoria);
                }
            }

            // Filtro de provincia
            const cumpleProvincia = !filtrosAvanzados.provincia ||
                                   animal.provincia === filtrosAvanzados.provincia;

            // Filtro de raza
            const cumpleRaza = !filtrosAvanzados.raza ||
                              animal.raza === filtrosAvanzados.raza;

            // Filtro de color
            const cumpleColor = !filtrosAvanzados.color ||
                               animal.color === filtrosAvanzados.color;

            // Filtro de tamaño
            const cumpleTamano = !filtrosAvanzados.tamano ||
                                animal.tamano === filtrosAvanzados.tamano;

            // Filtro de tipo específico para "otros"
            const cumpleTipoAnimal = !filtrosAvanzados.tipo_animal ||
                                    animal.tipo === filtrosAvanzados.tipo_animal;

            return cumpleCategoria && cumpleProvincia && cumpleRaza &&
                   cumpleColor && cumpleTamano && cumpleTipoAnimal;
        });
    }

    // Obtener valores únicos de un campo
    function obtenerValoresUnicosAvanzado(animales, campo) {
        return animales
            .map(animal => animal[campo])
            .filter(valor => valor && valor.trim() !== '' && valor !== 'Sin especificar')
            .filter((valor, index, arr) => arr.indexOf(valor) === index)
            .sort();
    }

    // Actualizar selectores dinámicamente
    function actualizarSelectoresAvanzados(selectCambiado = '') {
        function filtrarAnimalesSin(campoExcluido) {
            return animalesData.filter(animal => {
                const tipo = animal.tipo.toLowerCase();

                // Filtro de categoría
                if (filtrosAvanzados.categoria && filtrosAvanzados.categoria !== 'todos') {
                    if (filtrosAvanzados.categoria === 'otros') {
                        if (tipo.includes('perro') || tipo.includes('gato')) {
                            return false;
                        }
                    } else {
                        if (!tipo.includes(filtrosAvanzados.categoria)) {
                            return false;
                        }
                    }
                }

                if (campoExcluido !== 'provincia' && filtrosAvanzados.provincia &&
                    animal.provincia !== filtrosAvanzados.provincia) return false;
                if (campoExcluido !== 'raza' && filtrosAvanzados.raza &&
                    animal.raza !== filtrosAvanzados.raza) return false;
                if (campoExcluido !== 'color' && filtrosAvanzados.color &&
                    animal.color !== filtrosAvanzados.color) return false;
                if (campoExcluido !== 'tamano' && filtrosAvanzados.tamano &&
                    animal.tamano !== filtrosAvanzados.tamano) return false;
                if (campoExcluido !== 'tipo_animal' && filtrosAvanzados.tipo_animal &&
                    animal.tipo !== filtrosAvanzados.tipo_animal) return false;

                return true;
            });
        }

        // Actualizar provincias
        if (selectCambiado !== 'provincia') {
            const animalesParaUbicaciones = filtrarAnimalesSin('provincia');
            const provincias = obtenerValoresUnicosAvanzado(animalesParaUbicaciones, 'provincia');
            actualizarSelectAvanzado('ubicacion-select', provincias, 'Todas las ubicaciones', selectCambiado !== '' && selectCambiado !== 'provincia');
        }

        // Actualizar razas
        if (selectCambiado !== 'raza') {
            const animalesParaRazas = filtrarAnimalesSin('raza');
            const razas = obtenerValoresUnicosAvanzado(animalesParaRazas, 'raza');
            const textoRaza = filtrosAvanzados.categoria === 'otros' ? 'Cualquier variedad' : 'Cualquier raza';
            actualizarSelectAvanzado('raza-select', razas, textoRaza, selectCambiado !== '' && selectCambiado !== 'raza');
        }

        // Actualizar colores
        if (selectCambiado !== 'color') {
            const animalesParaColores = filtrarAnimalesSin('color');
            const colores = obtenerValoresUnicosAvanzado(animalesParaColores, 'color');
            actualizarSelectAvanzado('color-select', colores, 'Cualquier color', selectCambiado !== '' && selectCambiado !== 'color');
        }

        // Actualizar tamaños
        if (selectCambiado !== 'tamano') {
            const animalesParaTamanos = filtrarAnimalesSin('tamano');
            const tamanos = obtenerValoresUnicosAvanzado(animalesParaTamanos, 'tamano');
            actualizarSelectAvanzado('tamano-select', tamanos, 'Cualquier tamaño', selectCambiado !== '' && selectCambiado !== 'tamano');
        }

        // Actualizar tipos de animal para "otros"
        if (filtrosAvanzados.categoria === 'otros' && selectCambiado !== 'tipo_animal') {
            const animalesParaTipos = filtrarAnimalesSin('tipo_animal');
            const tipos = obtenerValoresUnicosAvanzado(animalesParaTipos, 'tipo');
            actualizarSelectAvanzado('otros-animales-select', tipos, 'Selecciona un tipo', selectCambiado !== '' && selectCambiado !== 'tipo_animal');
        }
    }

    // Actualizar un selector específico
    function actualizarSelectAvanzado(selectId, opciones, textoDefault, mantenerValor = false) {
        const select = document.getElementById(selectId);
        if (!select) return;

        const valorActual = select.value;

        select.innerHTML = `<option value="">${textoDefault}</option>`;

        opciones.forEach(opcion => {
            const optionElement = document.createElement('option');
            optionElement.value = opcion;
            optionElement.textContent = opcion;
            select.appendChild(optionElement);
        });

        if (mantenerValor && valorActual && opciones.includes(valorActual)) {
            select.value = valorActual;
        } else if (mantenerValor && valorActual && !opciones.includes(valorActual)) {
            const campo = selectId.replace('-select', '').replace('ubicacion', 'provincia').replace('otros-animales', 'tipo_animal');
            if (filtrosAvanzados[campo] === valorActual) {
                filtrosAvanzados[campo] = '';
            }
        }
    }

    // Aplicar filtros avanzados
    function aplicarFiltrosAvanzados() {
        // Filtrar animales según criterios
        animalesFiltrados = animalesData.filter(animal => {
            const tipo = normalizarTexto(animal.tipo);
            const raza = animal.raza || '';
            const provincia = animal.provincia || '';
            const color = animal.color || '';
            const tamano = animal.tamano || '';

            // Filtro de categoría
            let cumpleCategoria = true;
            if (filtrosAvanzados.categoria && filtrosAvanzados.categoria !== 'todos') {
                if (filtrosAvanzados.categoria === 'otros') {
                    cumpleCategoria = !tipo.includes('perro') && !tipo.includes('gato');
                } else {
                    cumpleCategoria = tipo.includes(filtrosAvanzados.categoria);
                }
            }

            const cumpleProvincia = !filtrosAvanzados.provincia || provincia === filtrosAvanzados.provincia;
            const cumpleRaza = !filtrosAvanzados.raza || raza === filtrosAvanzados.raza;
            const cumpleColor = !filtrosAvanzados.color || color === filtrosAvanzados.color;
            const cumpleTamano = !filtrosAvanzados.tamano || tamano === filtrosAvanzados.tamano;
            const cumpleTipoAnimal = !filtrosAvanzados.tipo_animal || animal.tipo === filtrosAvanzados.tipo_animal;

            return cumpleCategoria && cumpleProvincia && cumpleRaza &&
                   cumpleColor && cumpleTamano && cumpleTipoAnimal;
        });

        // Reiniciar contenedor y cargar primer lote
        const contenedor = document.getElementById('contenedorAnimales');
        contenedor.innerHTML = '';
        animalesMostrados = 0;

        cargarSiguienteLote();

        // Re-agregar y re-observar sentinela
        contenedor.appendChild(sentinela);
        scrollObserver.observe(sentinela);
    }

    // Limpiar todos los filtros avanzados
    function limpiarFiltrosAvanzados() {
        filtrosAvanzados = {
            categoria: 'todos',
            provincia: '',
            raza: '',
            color: '',
            tamano: '',
            tipo_animal: ''
        };

        document.querySelectorAll('.animal-card-selector').forEach(card => {
            card.classList.remove('active');
        });
        document.getElementById('card-todos').classList.add('active');

        const ubicacionSelect = document.getElementById('ubicacion-select');
        const razaSelect = document.getElementById('raza-select');
        const colorSelect = document.getElementById('color-select');
        const tamanoSelect = document.getElementById('tamano-select');
        const otrosAnimalesSelect = document.getElementById('otros-animales-select');

        if (ubicacionSelect) ubicacionSelect.value = '';
        if (razaSelect) razaSelect.value = '';
        if (colorSelect) colorSelect.value = '';
        if (tamanoSelect) tamanoSelect.value = '';
        if (otrosAnimalesSelect) otrosAnimalesSelect.value = '';

        const otrosField = document.getElementById('otros-animales-field');
        if (otrosField) {
            otrosField.classList.remove('show');
        }

        actualizarSelectoresAvanzados('');
        aplicarFiltrosAvanzados();
    }

    // Configurar event listeners para filtros avanzados
    function configurarFiltrosAvanzados() {
        const ubicacionSelect = document.getElementById('ubicacion-select');
        if (ubicacionSelect) {
            ubicacionSelect.addEventListener('change', function() {
                filtrosAvanzados.provincia = this.value;
                actualizarSelectoresAvanzados('provincia');
                aplicarFiltrosAvanzados();
            });
        }

        const razaSelect = document.getElementById('raza-select');
        if (razaSelect) {
            razaSelect.addEventListener('change', function() {
                filtrosAvanzados.raza = this.value;
                actualizarSelectoresAvanzados('raza');
                aplicarFiltrosAvanzados();
            });
        }

        const colorSelect = document.getElementById('color-select');
        if (colorSelect) {
            colorSelect.addEventListener('change', function() {
                filtrosAvanzados.color = this.value;
                actualizarSelectoresAvanzados('color');
                aplicarFiltrosAvanzados();
            });
        }

        const tamanoSelect = document.getElementById('tamano-select');
        if (tamanoSelect) {
            tamanoSelect.addEventListener('change', function() {
                filtrosAvanzados.tamano = this.value;
                actualizarSelectoresAvanzados('tamano');
                aplicarFiltrosAvanzados();
            });
        }

        const otrosSelect = document.getElementById('otros-animales-select');
        if (otrosSelect) {
            otrosSelect.addEventListener('change', function() {
                filtrosAvanzados.tipo_animal = this.value;
                actualizarSelectoresAvanzados('tipo_animal');
                aplicarFiltrosAvanzados();
            });
        }

        // Event listeners para el formulario de crear animal - selector de color
        const animalColorSelect = document.getElementById('animal_color_select');
        if (animalColorSelect) {
            animalColorSelect.addEventListener('change', manejarCambioColor);
        }

        const animalColorCustom = document.getElementById('animal_color_custom');
        if (animalColorCustom) {
            animalColorCustom.addEventListener('input', actualizarColorPersonalizado);
        }
    }

    // Modal de crear animal
    function abrirCrearAnimal() {
        const modal = document.getElementById('crearAnimalModal');
        const content = document.getElementById('crearAnimalContent');
        
        modal.classList.remove('hidden');
        setTimeout(() => {
            content.classList.remove('scale-95', 'opacity-0');
            content.classList.add('scale-100', 'opacity-100');
        }, 10);
    }

    function cerrarCrearAnimal() {
        const modal = document.getElementById('crearAnimalModal');
        const content = document.getElementById('crearAnimalContent');

        content.classList.remove('scale-100', 'opacity-100');
        content.classList.add('scale-95', 'opacity-0');

        setTimeout(() => {
            modal.classList.add('hidden');
            resetCrearAnimalForm();
            // Limpiar las imágenes y videos seleccionados
            modalSelectedImages = [];
            modalSelectedVideos = [];
            updateModalImagePreview();
            updateModalVideoPreview();
        }, 500);
    }

    // Reset del formulario de crear animal
    function resetCrearAnimalForm() {
        const form = document.getElementById('crearAnimalFormElement');
        if (form) form.reset();
        
        setCrearAnimalButtonLoading(false);
        showCrearAnimalOverlay(false);
        
        quitarImagen();
        quitarVideo();
        resetColorSelector(); // Agregado para resetear el selector de color
    }

    // Loading states
    function setCrearAnimalButtonLoading(loading = true) {
        const button = document.getElementById('crearAnimalSubmitBtn');
        if (!button) return;
        
        const textSpan = button.querySelector('.button-text');
        const loadingSpan = button.querySelector('.button-loading');
        
        if (loading) {
            if (textSpan) textSpan.classList.add('hidden');
            if (loadingSpan) loadingSpan.classList.remove('hidden');
            button.disabled = true;
            button.classList.add('opacity-75', 'cursor-not-allowed');
        } else {
            if (textSpan) textSpan.classList.remove('hidden');
            if (loadingSpan) loadingSpan.classList.add('hidden');
            button.disabled = false;
            button.classList.remove('opacity-75', 'cursor-not-allowed');
        }
    }

    function showCrearAnimalOverlay(show = true) {
        const overlay = document.getElementById('crearAnimalLoadingOverlay');
        if (overlay) {
            if (show) {
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }
    }

    // Función para cerrar el contenedor de errores
    function cerrarErrores() {
        const container = document.getElementById('formErrorsContainer');
        if (container) {
            container.classList.add('hidden');
        }
    }

    // Función para mostrar errores en el modal
    function mostrarErroresFormulario(errores) {
        const container = document.getElementById('formErrorsContainer');
        const lista = document.getElementById('formErrorsList');

        if (!container || !lista) return;

        // Limpiar errores anteriores
        lista.innerHTML = '';

        // Traducir nombres de campos a español
        const traducciones = {
            'nombre': 'Nombre',
            'tipo_de_animal': 'Tipo de Animal',
            'raza': 'Raza',
            'tamano': 'Tamaño',
            'color': 'Color',
            'imagen': 'Imagen',
            'video': 'Video',
            'email': 'Email',
            'telefono': 'Teléfono',
            'poblacion': 'Población',
            'provincia': 'Provincia',
            'codigo_postal': 'Código Postal',
            'descripcion': 'Descripción'
        };

        // Agregar cada error a la lista
        for (const [campo, mensajes] of Object.entries(errores)) {
            const nombreCampo = traducciones[campo] || campo;
            mensajes.forEach(mensaje => {
                const li = document.createElement('li');
                li.textContent = `${nombreCampo}: ${mensaje}`;
                lista.appendChild(li);
            });
        }

        // Mostrar el contenedor
        container.classList.remove('hidden');

        // Scroll hacia arriba del modal para ver los errores
        const modalContent = document.getElementById('crearAnimalContent');
        if (modalContent) {
            modalContent.scrollTop = 0;
        }
    }

    // Manejar el envío del formulario de crear animal por AJAX
    function initCrearAnimalFormSubmit() {
        const form = document.getElementById('crearAnimalFormElement');
        if (!form) return;

        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            // Ocultar errores anteriores
            cerrarErrores();

            // Validar color antes de enviar
            if (!validarColorAntesDelEnvio()) {
                return;
            }

            // Mostrar loading
            setCrearAnimalButtonLoading(true);
            showCrearAnimalOverlay(true);

            // Crear FormData con todos los campos del formulario
            const formData = new FormData(form);

            try {
                const response = await fetch('/crear_animal/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                    }
                });

                const data = await response.json();

                if (data.success) {
                    // Éxito: cerrar modal y recargar página
                    cerrarCrearAnimal();
                    window.location.href = '/mis_animales/';
                } else {
                    // Error: mostrar errores en el modal
                    if (data.errors) {
                        mostrarErroresFormulario(data.errors);
                    }
                    setCrearAnimalButtonLoading(false);
                    showCrearAnimalOverlay(false);
                }
            } catch (error) {
                console.error('Error al crear animal:', error);
                mostrarErroresFormulario({
                    'general': ['Error al conectar con el servidor. Por favor, intenta de nuevo.']
                });
                setCrearAnimalButtonLoading(false);
                showCrearAnimalOverlay(false);
            }
        });
    }

    // Indicadores de archivos con opción de quitar
    function initFileIndicators() {
        const imagenInput = document.getElementById('animal_imagen');
        const videoInput = document.getElementById('animal_video');

        if (imagenInput) {
            imagenInput.addEventListener('change', function(e) {
                const statusDiv = document.getElementById('imagenStatus');
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    const fileName = file.name;
                    const fileSize = (file.size / (1024 * 1024)).toFixed(2);
                    
                    if (statusDiv) {
                        statusDiv.innerHTML = `
                            <div class="file-indicator flex items-center justify-between">
                                <div>
                                    <span class="text-green-400">✓ Imagen: ${fileName}</span>
                                    <span class="text-xs text-gray-400 block">${fileSize} MB</span>
                                </div>
                                <button type="button" onclick="quitarImagen()" 
                                        class="ml-3 text-red-400 hover:text-red-300 transition-colors duration-200 text-sm font-medium flex items-center gap-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                    Quitar
                                </button>
                            </div>
                        `;
                        statusDiv.classList.remove('hidden');
                    }
                } else {
                    if (statusDiv) {
                        statusDiv.classList.add('hidden');
                        statusDiv.innerHTML = '';
                    }
                }
            });
        }

        if (videoInput) {
            videoInput.addEventListener('change', function(e) {
                const statusDiv = document.getElementById('videoStatus');
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    const fileName = file.name;
                    const fileSize = (file.size / (1024 * 1024)).toFixed(2);
                    
                    if (statusDiv) {
                        statusDiv.innerHTML = `
                            <div class="file-indicator flex items-center justify-between">
                                <div>
                                    <span class="text-green-400">✓ Video: ${fileName}</span>
                                    <span class="text-xs text-gray-400 block">${fileSize} MB</span>
                                </div>
                                <button type="button" onclick="quitarVideo()" 
                                        class="ml-3 text-red-400 hover:text-red-300 transition-colors duration-200 text-sm font-medium flex items-center gap-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                    Quitar
                                </button>
                            </div>
                        `;
                        statusDiv.classList.remove('hidden');
                    }
                } else {
                    if (statusDiv) {
                        statusDiv.classList.add('hidden');
                        statusDiv.innerHTML = '';
                    }
                }
            });
        }

        // La validación del formulario se maneja en initCrearAnimalFormSubmit()
        // No es necesario agregar otro event listener aquí
    }

    // ========== FUNCIONES PARA MÚLTIPLES IMÁGENES Y VIDEOS EN MODAL ==========
    let modalSelectedImages = [];
    let modalSelectedVideos = [];

    // Manejar selección de imágenes en el modal
    function handleModalImageSelection(files) {
        const imageFiles = Array.from(files).filter(file => file.type.startsWith('image/'));

        // Verificar cuántas imágenes podemos agregar
        const espacioDisponible = 10 - modalSelectedImages.length;

        if (espacioDisponible === 0) {
            showModalNotification('⚠️ Ya has alcanzado el máximo de 10 imágenes', 'warning');
            return;
        }

        if (imageFiles.length > espacioDisponible) {
            showModalNotification(`⚠️ Solo puedes agregar ${espacioDisponible} imagen(es) más`, 'warning');
            imageFiles.splice(espacioDisponible);
        }

        // Validar tamaño de archivos (5MB max)
        const validFiles = imageFiles.filter(file => {
            // Verificar que no sea un archivo duplicado
            const isDuplicate = modalSelectedImages.some(existingFile =>
                existingFile.name === file.name &&
                existingFile.size === file.size &&
                existingFile.lastModified === file.lastModified
            );

            if (isDuplicate) {
                showModalNotification(`⚠️ ${file.name} ya fue agregada`, 'warning');
                return false;
            }

            if (file.size > 5 * 1024 * 1024) {
                showModalNotification(`❌ ${file.name} es demasiado grande (máx. 5MB)`, 'error');
                return false;
            }
            return true;
        });

        if (validFiles.length > 0) {
            modalSelectedImages.push(...validFiles);
            showModalNotification(`✅ ${validFiles.length} imagen(es) agregada(s)`, 'success');
            updateModalImagePreview();
            updateModalImageInput();
        }
    }

    // Actualizar preview de imágenes en el modal
    function updateModalImagePreview() {
        const preview = document.getElementById('modalImagePreview');
        const dropZone = document.getElementById('modalDropZone');
        const counter = document.getElementById('modalImageCounter');
        const count = document.getElementById('modalImageCount');

        if (!preview || !dropZone || !counter || !count) return;

        if (modalSelectedImages.length === 0) {
            // Restaurar la zona de drop completa (mantener como label completo)
            dropZone.outerHTML = `
                <label for="modal_imagenes" id="modalDropZone" class="file-upload-btn px-6 py-4 rounded-xl border-2 border-dashed border-gray-600 hover:border-blue-400 transition-all duration-300 group block cursor-pointer">
                    <div class="flex flex-col items-center gap-3">
                        <div class="w-12 h-12 bg-blue-500/20 rounded-xl flex items-center justify-center group-hover:bg-blue-500/30 transition-colors">
                            <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                        <div class="text-center">
                            <p class="text-white font-medium">Subir Imágenes</p>
                            <p class="text-gray-400 text-sm">Arrastra aquí o haz clic para seleccionar</p>
                            <input type="file" id="modal_imagenes" name="imagenes" accept="image/*" multiple class="hidden" onchange="handleModalImageSelection(this.files)">
                            <p class="text-xs text-gray-500 mt-2">Máximo 10 imágenes • JPG, PNG, GIF, WebP • Hasta 5MB</p>
                        </div>
                    </div>
                </label>
            `;
            preview.style.display = 'none';
            counter.style.display = 'none';
            // Re-obtener el dropZone después de reemplazarlo
            setTimeout(() => setupModalDragAndDrop(), 100);
            return;
        }

        // Mostrar botón más pequeño para agregar más (también completamente clickeable)
        if (modalSelectedImages.length < 10) {
            dropZone.outerHTML = `
                <label for="modal_imagenes_2" id="modalDropZone" class="file-upload-btn px-6 py-2 rounded-xl border-2 border-dashed border-gray-600 hover:border-blue-400 transition-all duration-300 group block cursor-pointer">
                    <div class="flex items-center justify-center gap-2">
                        <span class="text-sm text-blue-400">➕ Agregar más imágenes</span>
                        <input type="file" id="modal_imagenes_2" name="imagenes" accept="image/*" multiple class="hidden" onchange="handleModalImageSelection(this.files)">
                    </div>
                </label>
            `;
        } else {
            dropZone.style.display = 'none';
        }

        preview.style.display = 'grid';
        counter.style.display = 'block';
        count.textContent = modalSelectedImages.length;

        preview.innerHTML = '';

        modalSelectedImages.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const div = document.createElement('div');
                div.className = 'relative rounded-lg overflow-hidden bg-gray-700 aspect-square';
                div.innerHTML = `
                    <img src="${e.target.result}" alt="${file.name}" class="w-full h-full object-cover">
                    ${index === 0 ? '<span class="absolute top-1 left-1 text-xs bg-green-500 text-white px-2 py-1 rounded">Principal</span>' : ''}
                    <button type="button" onclick="removeModalImage(${index})" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm hover:bg-red-600">
                        ×
                    </button>
                `;
                preview.appendChild(div);
            };
            reader.readAsDataURL(file);
        });

        // Re-configurar drag & drop para la nueva zona
        setTimeout(() => setupModalDragAndDrop(), 100);
    }

    // Eliminar imagen del modal
    function removeModalImage(index) {
        modalSelectedImages.splice(index, 1);
        updateModalImagePreview();
        updateModalImageInput();
        showModalNotification('🗑️ Imagen eliminada', 'info');
    }

    // Actualizar el input de imágenes del modal
    function updateModalImageInput() {
        const input = document.getElementById('modal_imagenes');
        if (!input) return;

        const dataTransfer = new DataTransfer();
        modalSelectedImages.forEach(file => dataTransfer.items.add(file));
        input.files = dataTransfer.files;
    }

    // Manejar selección de videos en el modal
    function handleModalVideoSelection(files) {
        const videoFiles = Array.from(files).filter(file => file.type.startsWith('video/'));

        const espacioDisponible = 5 - modalSelectedVideos.length;

        if (espacioDisponible === 0) {
            showModalNotification('⚠️ Ya has alcanzado el máximo de 5 videos', 'warning');
            return;
        }

        if (videoFiles.length > espacioDisponible) {
            showModalNotification(`⚠️ Solo puedes agregar ${espacioDisponible} video(s) más`, 'warning');
            videoFiles.splice(espacioDisponible);
        }

        // Validar tamaño de archivos (10MB max)
        const validFiles = videoFiles.filter(file => {
            const isDuplicate = modalSelectedVideos.some(existingFile =>
                existingFile.name === file.name &&
                existingFile.size === file.size
            );

            if (isDuplicate) {
                showModalNotification(`⚠️ ${file.name} ya fue agregado`, 'warning');
                return false;
            }

            if (file.size > 10 * 1024 * 1024) {
                showModalNotification(`❌ ${file.name} es demasiado grande (máx. 10MB)`, 'error');
                return false;
            }
            return true;
        });

        if (validFiles.length > 0) {
            modalSelectedVideos.push(...validFiles);
            showModalNotification(`✅ ${validFiles.length} video(s) agregado(s)`, 'success');
            updateModalVideoPreview();
        }
    }

    // Actualizar preview de videos en el modal
    function updateModalVideoPreview() {
        const preview = document.getElementById('modalVideoPreview');
        const counter = document.getElementById('modalVideoCounter');
        const count = document.getElementById('modalVideoCount');

        if (!preview || !counter || !count) return;

        if (modalSelectedVideos.length === 0) {
            preview.style.display = 'none';
            counter.style.display = 'none';
            return;
        }

        preview.style.display = 'grid';
        counter.style.display = 'block';
        count.textContent = modalSelectedVideos.length;

        preview.innerHTML = '';

        modalSelectedVideos.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const div = document.createElement('div');
                div.className = 'relative rounded-lg overflow-hidden bg-gray-700 aspect-square';
                div.innerHTML = `
                    <video src="${e.target.result}" class="w-full h-full object-cover"></video>
                    <button type="button" onclick="removeModalVideo(${index})" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm hover:bg-red-600">
                        ×
                    </button>
                `;
                preview.appendChild(div);
            };
            reader.readAsDataURL(file);
        });

        updateModalVideoInput();
    }

    // Eliminar video del modal
    function removeModalVideo(index) {
        modalSelectedVideos.splice(index, 1);
        updateModalVideoPreview();
        showModalNotification('🗑️ Video eliminado', 'info');
    }

    // Actualizar el input de videos del modal
    function updateModalVideoInput() {
        const input = document.getElementById('modal_videos');
        if (!input) return;

        const dataTransfer = new DataTransfer();
        modalSelectedVideos.forEach(file => dataTransfer.items.add(file));
        input.files = dataTransfer.files;
    }

    // Función para mostrar notificaciones en el modal
    function showModalNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `fixed top-20 right-4 px-6 py-3 rounded-lg shadow-lg z-[60] transform transition-all duration-300 translate-x-full`;

        const colors = {
            'info': 'bg-blue-500',
            'success': 'bg-green-500',
            'warning': 'bg-yellow-500',
            'error': 'bg-red-500'
        };

        notification.classList.add(colors[type] || colors.info, 'text-white');
        notification.textContent = message;

        document.body.appendChild(notification);

        setTimeout(() => {
            notification.classList.remove('translate-x-full');
        }, 10);

        setTimeout(() => {
            notification.classList.add('translate-x-full');
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 300);
        }, 3000);
    }

    // Configurar drag and drop para el modal
    function setupModalDragAndDrop() {
        const dropZone = document.getElementById('modalDropZone');
        if (!dropZone) return;

        // Prevenir comportamiento por defecto
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.removeEventListener(eventName, preventDefaultsModal);
            dropZone.addEventListener(eventName, preventDefaultsModal, false);
        });

        // Highlight drop zone
        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.removeEventListener(eventName, highlightDropZone);
            dropZone.addEventListener(eventName, highlightDropZone, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.removeEventListener(eventName, unhighlightDropZone);
            dropZone.addEventListener(eventName, unhighlightDropZone, false);
        });

        // Manejar drop
        dropZone.removeEventListener('drop', handleModalDrop);
        dropZone.addEventListener('drop', handleModalDrop, false);
    }

    function preventDefaultsModal(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    function highlightDropZone() {
        const dropZone = document.getElementById('modalDropZone');
        if (dropZone) {
            dropZone.classList.add('border-blue-500', 'bg-blue-500', 'bg-opacity-10');
        }
    }

    function unhighlightDropZone() {
        const dropZone = document.getElementById('modalDropZone');
        if (dropZone) {
            dropZone.classList.remove('border-blue-500', 'bg-blue-500', 'bg-opacity-10');
        }
    }

    function handleModalDrop(e) {
        const files = e.dataTransfer.files;
        handleModalImageSelection(files);
    }

    // Inicializar drag and drop cuando el DOM esté listo
    document.addEventListener('DOMContentLoaded', function() {
        setupModalDragAndDrop();
    });

    function abrirLogin() {
        const modal = document.getElementById('authModal');
        const content = document.getElementById('modalContent');
        
        mostrarLogin();
        
        modal.classList.remove('hidden');
        setTimeout(() => {
            content.classList.remove('scale-95', 'opacity-0');
            content.classList.add('scale-100', 'opacity-100');
        }, 10);
    }

    function cerrarModal() {
        const modal = document.getElementById('authModal');
        const content = document.getElementById('modalContent');

        content.classList.remove('scale-100', 'opacity-100');
        content.classList.add('scale-95', 'opacity-0');

        setTimeout(() => {
            modal.classList.add('hidden');
            resetForms();
            // Ocultar mensaje de error al cerrar
            const errorMsg = document.getElementById('loginErrorMessage');
            if (errorMsg) {
                errorMsg.classList.add('hidden');
            }
        }, 500);
    }

    function cerrarErrorLogin() {
        const errorMsg = document.getElementById('loginErrorMessage');
        if (errorMsg) {
            errorMsg.classList.add('hidden');
        }
    }

    // Abrir modal automáticamente si hay error de login
    document.addEventListener('DOMContentLoaded', function() {
        {% if login_error %}
        // Hay un error de login, abrir el modal automáticamente
        setTimeout(function() {
            abrirLogin();
        }, 300);
        {% endif %}
    });

    function mostrarLogin() {
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        
        registerForm.style.opacity = '0';
        setTimeout(() => {
            registerForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
            setTimeout(() => {
                loginForm.style.opacity = '1';
            }, 10);
        }, 150);
    }

    function mostrarRegistro() {
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        
        loginForm.style.opacity = '0';
        setTimeout(() => {
            loginForm.classList.add('hidden');
            registerForm.classList.remove('hidden');
            setTimeout(() => {
                registerForm.style.opacity = '1';
            }, 10);
        }, 150);
    }

    function resetForms() {
        const loginForm = document.querySelector('#loginForm form');
        const registerForm = document.getElementById('registerFormElement');
        
        if (loginForm) loginForm.reset();
        if (registerForm) registerForm.reset();
        
        setRegisterButtonLoading(false);
        showRegisterOverlay(false);
    }

    function setRegisterButtonLoading(loading = true) {
        const button = document.getElementById('registerSubmitBtn');
        if (!button) return;
        
        const textSpan = button.querySelector('.button-text');
        const loadingSpan = button.querySelector('.button-loading');
        
        if (loading) {
            if (textSpan) textSpan.classList.add('hidden');
            if (loadingSpan) loadingSpan.classList.remove('hidden');
            button.disabled = true;
            button.classList.add('opacity-75', 'cursor-not-allowed');
        } else {
            if (textSpan) textSpan.classList.remove('hidden');
            if (loadingSpan) loadingSpan.classList.add('hidden');
            button.disabled = false;
            button.classList.remove('opacity-75', 'cursor-not-allowed');
        }
    }

    function showRegisterOverlay(show = true) {
        const overlay = document.getElementById('registerLoadingOverlay');
        if (overlay) {
            if (show) {
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }
    }

    function initModalForms() {
        const registerForm = document.getElementById('registerFormElement');

        if (registerForm) {
            registerForm.addEventListener('submit', function(e) {
                setRegisterButtonLoading(true);
                showRegisterOverlay(true);
            });
        }

        const loginForm = document.getElementById('loginForm');
        const registerFormDiv = document.getElementById('registerForm');
        
        if (loginForm) loginForm.style.opacity = '1';
        if (registerFormDiv) registerFormDiv.style.opacity = '1';
    }

    // Event listeners (ya no se usan, reemplazados por el buscador avanzado)
    // Los event listeners ahora están en configurarFiltrosAvanzados()

    document.getElementById('authModal').addEventListener('click', function(e) {
        if (e.target === this) cerrarModal();
    });

    document.getElementById('crearAnimalModal').addEventListener('click', function(e) {
        if (e.target === this) cerrarCrearAnimal();
    });

    // Inicialización
    document.addEventListener('DOMContentLoaded', function() {
        crearEstrellas();
        inicializarAnimales();
        actualizarContador(animalesData.length);
        actualizarContadorFavoritos();
        
        setTimeout(() => {
            document.querySelectorAll('.fade-in').forEach((el, i) => {
                setTimeout(() => {
                    el.style.opacity = '1';
                    el.style.transform = 'translateY(0)';
                }, i * 100);
            });
        }, 200);

        initModalForms();
        initFileIndicators();
        initCrearAnimalFormSubmit();

        // Inicializar buscador avanzado
        configurarFiltrosAvanzados();
        actualizarSelectoresAvanzados('');
        selectAnimalIndex('todos'); // Iniciar con todos activos
    });

    // Efecto parallax
    let ticking = false;
    
    window.addEventListener('scroll', () => {
        if (!ticking) {
            requestAnimationFrame(() => {
                const scrolled = window.pageYOffset;
                const stars = document.querySelectorAll('.star');
                
                stars.forEach((star, i) => {
                    if (i % 3 === 0) {
                        const speed = 0.5;
                        star.style.transform = `translateY(${scrolled * speed}px)`;
                    }
                });
                
                ticking = false;
            });
            ticking = true;
        }
    });

    // Función para limpiar errores de un campo específico
    function clearFieldError(fieldName) {
        const errorDiv = document.getElementById(fieldName + '-error');
        const field = document.getElementById('reg_' + fieldName);

        if (errorDiv) {
            errorDiv.classList.add('hidden');
            errorDiv.textContent = '';
        }

        if (field) {
            field.classList.remove('border-red-500');
        }
    }

    // Función para mostrar error en un campo específico
    function showFieldError(fieldName, message) {
        const errorDiv = document.getElementById(fieldName + '-error');
        const field = document.getElementById('reg_' + fieldName);

        if (errorDiv) {
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        if (field) {
            field.classList.add('border-red-500');
            field.focus();
        }
    }

    // Función para limpiar todos los errores del formulario
    function clearAllFieldErrors() {
        const fields = ['nombre', 'password', 'email', 'telefono', 'direccion', 'poblacion', 'provincia', 'codigo_postal', 'logo'];
        fields.forEach(clearFieldError);
    }

    // Validación client-side
    function validateRegistrationForm(formData) {
        const errors = {};

        // Validar nombre
        const nombre = formData.get('nombre');
        if (!nombre || nombre.trim().length < 2) {
            errors.nombre = 'El nombre debe tener al menos 2 caracteres';
        } else if (nombre.length > 50) {
            errors.nombre = 'El nombre no puede tener más de 50 caracteres';
        }

        // Validar contraseña
        const password = formData.get('password');
        if (!password || password.length < 6) {
            errors.password = 'La contraseña debe tener al menos 6 caracteres';
        }

        // Validar email
        const email = formData.get('email');
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!email || !emailRegex.test(email)) {
            errors.email = 'Por favor, introduce un email válido';
        }

        // Validar teléfono
        const telefono = formData.get('telefono');
        if (!telefono || telefono.trim().length < 9) {
            errors.telefono = 'Por favor, introduce un teléfono válido';
        }

        // Validar dirección
        const direccion = formData.get('direccion');
        if (!direccion || direccion.trim().length < 5) {
            errors.direccion = 'La dirección debe tener al menos 5 caracteres';
        }

        // Validar población
        const poblacion = formData.get('poblacion');
        if (!poblacion || poblacion.trim().length < 2) {
            errors.poblacion = 'Por favor, introduce una población válida';
        }

        // Validar provincia
        const provincia = formData.get('provincia');
        if (!provincia || provincia.trim().length < 2) {
            errors.provincia = 'Por favor, introduce una provincia válida';
        }

        // Validar código postal
        const codigoPostal = formData.get('codigo_postal');
        const cpRegex = /^[0-9]{4,5}$/;
        if (!codigoPostal || !cpRegex.test(codigoPostal)) {
            errors.codigo_postal = 'El código postal debe tener 4 o 5 dígitos';
        }

        return errors;
    }

    // Función para manejar el envío del formulario de registro
    function handleRegisterSubmit(event) {
    event.preventDefault();

    const form = event.target;
    const formData = new FormData(form);
    const errorMsg = document.getElementById('registerErrorMessage');
    const errorText = document.getElementById('registerErrorText');
    const successMsg = document.getElementById('registerSuccessMessage');
    const overlay = document.getElementById('registerLoadingOverlay');

    // Función para resetear el estado del botón
    function resetButtonState() {
        if (overlay) overlay.classList.add('hidden');
        setRegisterButtonLoading(false);
    }

    // Función para mostrar error general
    function showGeneralError(message) {
        if (errorMsg && errorText) {
            errorText.textContent = message;
            errorMsg.classList.remove('hidden');
            errorMsg.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }

    // Limpiar mensajes y errores previos
    clearAllFieldErrors();
    if (errorMsg) errorMsg.classList.add('hidden');
    if (successMsg) successMsg.classList.add('hidden');

    // Validación client-side
    const validationErrors = validateRegistrationForm(formData);
    if (Object.keys(validationErrors).length > 0) {
        Object.keys(validationErrors).forEach(field => {
            showFieldError(field, validationErrors[field]);
        });
        const firstErrorField = Object.keys(validationErrors)[0];
        const firstErrorElement = document.getElementById('reg_' + firstErrorField);
        if (firstErrorElement) firstErrorElement.focus();
        return false;
    }

    // Mostrar loading
    if (overlay) overlay.classList.remove('hidden');
    setRegisterButtonLoading(true);

    // Enviar formulario vía AJAX
    fetch('/registro/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(async response => {
        console.log('Response status:', response.status);
        console.log('Response ok:', response.ok);
        
        const contentType = response.headers.get('content-type');
        console.log('Content-Type:', contentType);
        
        // CASO 1: Respuesta exitosa
        if (response.ok && response.status === 200) {
            if (contentType && contentType.includes('application/json')) {
                const data = await response.json();
                console.log('JSON Response:', data);
                
                // Verificar si es realmente exitoso
                if (data.success === true) {
                    console.log('✅ Registro exitoso');
                    if (successMsg) {
                        successMsg.classList.remove('hidden');
                    }
                    setTimeout(() => {
                        window.location.href = data.redirect || '/registro_exitoso/';
                    }, 2000);
                    return; // ⚠️ IMPORTANTE: Salir aquí para no continuar
                } else {
                    // JSON pero con error
                    console.log('❌ JSON con error:', data);
                    if (data.error === 'duplicate_name') {
                        showFieldError('nombre', 'Ya existe una asociación registrada con este nombre. Por favor, elige otro nombre.');
                    } else {
                        showGeneralError(data.message || 'Error en el registro');
                    }
                    return;
                }
            } else {
                // Respuesta de texto - puede ser redirect o HTML
                const text = await response.text();
                console.log('Text response:', text.substring(0, 200));
                
                if (text.includes('registro_exitoso') || text.includes('success')) {
                    console.log('✅ Registro exitoso (text)');
                    window.location.href = '/registro_exitoso/';
                    return;
                } else {
                    console.log('❌ Texto inesperado');
                    showGeneralError('Respuesta inesperada del servidor');
                    return;
                }
            }
        }
        
        // CASO 2: Respuesta con error del servidor (400, 500, etc.)
        else if (!response.ok) {
            if (contentType && contentType.includes('application/json')) {
                const data = await response.json();
                console.log('Error JSON Response:', data);
                
                if (data.error === 'duplicate_name') {
                    showFieldError('nombre', 'Ya existe una asociación registrada con este nombre. Por favor, elige otro nombre.');
                } else if (data.error === 'form_errors' && data.form_errors) {
                    Object.keys(data.form_errors).forEach(field => {
                        const errors = data.form_errors[field];
                        if (errors && errors.length > 0) {
                            showFieldError(field, errors[0]);
                        }
                    });
                } else {
                    showGeneralError(data.message || 'Error al registrar la asociación.');
                }
            } else {
                const text = await response.text();
                console.log('Error text response:', text.substring(0, 200));
                
                if (text.includes('Ya existe una asociación')) {
                    showFieldError('nombre', 'Ya existe una asociación registrada con este nombre. Por favor, elige otro nombre.');
                } else {
                    showGeneralError('Error al registrar la asociación. Por favor, verifica los datos.');
                }
            }
        }
    })
    .catch(error => {
        console.error('❌ Error de conexión:', error);
        showGeneralError('Error de conexión. Por favor, intenta nuevamente.');
    })
    .finally(() => {
        resetButtonState();
    });

    return false;
}

    // Agregar validación en tiempo real para los campos del formulario
    function setupRealTimeValidation() {
        const fields = [
            { name: 'nombre', validation: (value) => value.trim().length >= 2 && value.length <= 50 },
            { name: 'password', validation: (value) => value.length >= 6 },
            { name: 'email', validation: (value) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value) },
            { name: 'telefono', validation: (value) => value.trim().length >= 9 },
            { name: 'direccion', validation: (value) => value.trim().length >= 5 },
            { name: 'poblacion', validation: (value) => value.trim().length >= 2 },
            { name: 'provincia', validation: (value) => value.trim().length >= 2 },
            { name: 'codigo_postal', validation: (value) => /^[0-9]{4,5}$/.test(value) }
        ];

        fields.forEach(field => {
            const input = document.getElementById('reg_' + field.name);
            if (input) {
                // Limpiar error cuando el usuario empieze a escribir
                input.addEventListener('input', function() {
                    clearFieldError(field.name);

                    // Limpiar mensaje de error general si existe
                    const errorMsg = document.getElementById('registerErrorMessage');
                    if (errorMsg && !errorMsg.classList.contains('hidden')) {
                        errorMsg.classList.add('hidden');
                    }
                });

                // Validación cuando pierde el foco (blur)
                input.addEventListener('blur', function() {
                    const value = input.value;
                    if (value && !field.validation(value)) {
                        let errorMessage = '';

                        switch(field.name) {
                            case 'nombre':
                                errorMessage = 'El nombre debe tener entre 2 y 50 caracteres';
                                break;
                            case 'password':
                                errorMessage = 'La contraseña debe tener al menos 6 caracteres';
                                break;
                            case 'email':
                                errorMessage = 'Por favor, introduce un email válido';
                                break;
                            case 'telefono':
                                errorMessage = 'El teléfono debe tener al menos 9 caracteres';
                                break;
                            case 'direccion':
                                errorMessage = 'La dirección debe tener al menos 5 caracteres';
                                break;
                            case 'poblacion':
                                errorMessage = 'Por favor, introduce una población válida';
                                break;
                            case 'provincia':
                                errorMessage = 'Por favor, introduce una provincia válida';
                                break;
                            case 'codigo_postal':
                                errorMessage = 'El código postal debe tener 4 o 5 dígitos';
                                break;
                        }

                        if (errorMessage) {
                            showFieldError(field.name, errorMessage);
                        }
                    }
                });
            }
        });
    }

    // Limpiar error cuando el usuario cambie el nombre
    document.addEventListener('DOMContentLoaded', function() {
        setupRealTimeValidation();
    });
</script>

</body>
</html>